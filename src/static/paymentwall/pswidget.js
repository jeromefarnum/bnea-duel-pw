var PaymentSystems=Class.create({initialize:function(container,opt){this.id='ps';this.contentId=this.id+'_content';this.buttonId=this.id+'_psb';this.priceId=this.id+'_price';this.priceFormId=this.id+'_price_form';this.priceCntId=this.id+'_price_cnt';this.priceTableCntId=this.id+'_price_table_cnt';this.priceMsgId=this.id+'_price_msg';this.newWindowPopupId=this.id+'_new_window_popup';this.recurringMessageContainer=this.id+'_recurring_message_container';this.recurringMessageId=this.id+'_recurring_message';this.backButtonId=this.id+'_back_button';this.backButtonIndexId=this.id+'_back_button_index';this.mobileWidget=opt.mobileWidget||0;this.showMessagesUnderButton=opt.showMessagesUnderButton||0;this.countryCode=opt.countryCode||0;this.showCartFees=opt.showCartFees||false;this.couponValue='';this.priceDefault='';this.pricesView=opt.pricesView||0;this.container=container;this.total=opt.total;this.visible=opt.visible||6;if(opt.prices){this.prices=opt.prices}if(opt.smsOperators){this.smsOperators=opt.smsOperators}this.system=opt.system;this.temporarySystem=this.system;this.selectedSystem=this.system;this.previousSystem=this.system;if(opt.paymentSystems){this.paymentSystems=opt.paymentSystems}this.currency=opt.currency;this.clickAction=opt.clickAction||'select';this.hidePreloaderOnPsWidgetLoad=opt.hidePreloaderOnPsWidgetLoad||false;this.showPsAfterCheckPrice=opt.showPsAfterCheckPrice||false;this.showPsAfterCheckPriceOnlyInSameWindow=opt.showPsAfterCheckPriceOnlyInSameWindow||false;this.useLastPriceAsDefaultOnSelectingPs=opt.useLastPriceAsDefaultOnSelectingPs||false;this.showSelectedProduct=opt.showSelectedProduct||false;this.pricePointsSupFractionalPart=opt.pricePointsSupFractionalPart||false;this.flexibleAmount=opt.flexibleAmount||false;if(this.flexibleAmount){this.flexibleAmountContainer=opt.flexibleAmountContainer||'flexible_amount';this.flexibleCurrencyContainer=opt.flexibleCurrencyContainer||'flexible_currency'}this.useSubscriptions=opt.useSubscriptions||false;this.displaySubscriptionMonthlyPrices=opt.displaySubscriptionMonthlyPrices||false;this.hidePricesBeforeSelection=opt.hidePricesBeforeSelection||false;this.hidePaymentMethodsAfterSelection=opt.hidePaymentMethodsAfterSelection||false;this.hideAllAfterSelection=opt.hideAllAfterSelection||false;if(this.hidePricesBeforeSelection){$(this.contentId).hide()}this.showPsAfterSelectingPs=opt.showPsAfterSelectingPs||false;this.showPsAfterSelectingPsOnlyInSameWindow=opt.showPsAfterSelectingPsOnlyInSameWindow||false;if(this.showPsAfterSelectingPsOnlyInSameWindow){this.showPreloaderOnPsLoadInSameWindow=true}this.titles=opt.titles||{};this.recurringSystems=opt.recurringSystems||{};if(opt.showPaypalEcheckNotice){this.showPaypalEcheckNotice=true}if(opt.showPaypalButtonBranding){this.showPaypalButtonBranding=true;this.paypalButtonBrandingNotice=opt.paypalButtonBrandingNotice}this.appendPaymentForm=opt.appendPaymentForm||false;this.psPopUpDimensions=opt.psPopUpDimensions||false;this.gatewayLocalBrands=[];if(typeof gatewayLocalBrands!=='undefined'){for(var countryCode in gatewayLocalBrands){var brands=gatewayLocalBrands[countryCode];for(var i in brands){this.gatewayLocalBrands.push(brands[i].shortcode)}}}this.paypalCountries=opt.paypalCountries||null;this.webmoneyCurrency=opt.webmoneyCurrency||null;this.epinCurrency=opt.epinCurrency||null;this.showPsInNewWindow=opt.showPsInNewWindow||false;this.showPsInSameWindow=opt.showPsInSameWindow||false;this.deactivateWidgetOnNewWindowOpened=opt.deactivateWidgetOnNewWindowOpened||false;this.togglePriceOverDisable=opt.togglePriceOverDisable||false;this.customVC=opt.customVC||false;if(this.customVC){this.customVcAmountPriceViewId='flex_price_formatted';this.customVcAmountPriceInputId='flex_price_formatted_input';this.customVcAmountPriceInputContainerId='flex_price_formatted_input_container';this.customVcAmountInputId='flex_price_formatted'}this.nonIframePsInPopup=opt.nonIframePsInPopup||false;this.loginRequired=opt.loginRequired||false;this.customCommission=opt.customCommission||false;this.isRecentPaymentCheckActive=opt.isRecentPaymentCheckActive||false;this.isTransactionVerificationFlowActive=opt.isTransactionVerificationFlowActive||false;this.isTransactionVerificationFlowProgressBarDisplayed=false;this.opt=opt;this.currentPaymentStep='selectPackage';if($(this.container)){if(this.visible=='auto'){this.visible=this.getAutoVisible()}var ref=this;$(this.container).select('a').each(function(a){$(a).observe('click',ref.open.bindAsEventListener(ref,a.rel))});this.page=1;this.initPager()}this.afterUpdatePricePoints(this.system);this.listenRows();this.listenBuyButtonClick();this.listenBackButton();this.afterInitialize();this.additionalParams={};this.onSelectPriceListeners=[];this.afterInitHook();this.couponChecked=false;this.couponsFieldAvailable=opt.couponsFieldAvailable||false;this.couponError=false;this.couponLastError=false;this.observeCouponClick();this.trackGoogleAnalyticsEvent('widget_loaded');this.onClientSideCallbackEvent('widgetLoaded');this.keysShown=false;this.activeRecentPaymentChecks=[];this.clickProperty=opt.clickProperty||0;this.transactionVerificationFlowUsed=false;this.transactionVerificationFinished=false;this.progressCache={};this.recentPaymentCheckTimeout=null;this.recentPaymentCheckPsShortname=''},afterInitHook:function(){},clearCoupon:function(){if($('coupon_code_submit')){$('coupon_code_submit').update('Apply');$('coupon_code_submit').stopObserving('click');$('coupon_code_submit').observe('click',this.checkCouponAjax.bind(this,this.getPrice()));$('coupon_code').value='';this.couponValue='';this.couponChecked=false}},applyCoupon:function(){if(this.couponsFieldAvailable){var coupon=$('coupon_code');if(coupon){var couponValue=coupon.value;if((couponValue||this.couponValue)&&!this.couponChecked){this.couponValue=couponValue||this.couponValue;if(!couponValue){coupon.value=this.couponValue}this.checkCouponAjax(this.getPrice())}}}},checkCouponAjax:function(priceId){var ref=this;var currentPrice=this.getPriceData(priceId);if(this.couponsFieldAvailable&&!this.isMobileSystem()){var coupon_code=$('coupon_code').value||this.couponValue;new Ajax.Request(BaseUrl+'api/coupons/check/?'+UrlParams,{method:'get',parameters:{id:coupon_code,price_amount:currentPrice.amount,price_currency:currentPrice.cu_code},onLoading:function(){$('coupon_code_submit').update('loading...')},onSuccess:function(response){var responseText=response.responseText.evalJSON();if(responseText.widget&&!responseText.error){ref.afterCheckCouponSuccess(priceId,responseText)}else{ref.clearCoupon();ref.afterCheckCouponFailed(responseText)}}})}},isMobileSystem:function(){if(arguments[0]){var system=arguments[0];this.temporarySystem=system}else{var system=this.temporarySystem}return!this.paymentSystems[system].editable},afterInitialize:function(){},listenBuyButtonClick:function(){if($(this.buttonId)){var ref=this;$(this.buttonId).observe('click',ref.selectPrice.bindAsEventListener(ref))}},getWidgetCustomDimensions:function(){if(this.psPopUpDimensions[this.system]){var x=this.psPopUpDimensions[this.system][0];var y=this.psPopUpDimensions[this.system][1]}else if(this.psPopUpDimensions['all']){var x=this.psPopUpDimensions['all'][0];var y=this.psPopUpDimensions['all'][1]}else{var x=950;var y=600}return new Array(x,y)},getWidgetCustomLocation:function(){if(this.psPopUpDimensions['ps_popup_location_active']){var location=this.psPopUpDimensions['ps_popup_location_active']}else{var location='no'}return location},listenRows:function(){var ref=this;$(this.priceId).select(ref.getRowSelectorForListenRows()).each(function(r){if(!ref.togglePriceOverDisable){r.observe('mouseover',ref.togglePriceOver.curry(ref));r.observe('mouseout',ref.togglePriceOver.curry(ref))}r.observe('click',ref.checkPrice.curry(ref))});var checkedPrice=this.getCheckedPrice();if(checkedPrice!=null){var checkedId=checkedPrice.pluck('id')[0]}if(checkedId!='undefined'){this.checkedRow=$(checkedId+'_')}},getRowSelectorForListenRows:function(){return'tr'},loginFormDefined:function(){return typeof loginForm!=='undefined'},confirmFormDefined:function(){return typeof confirmForm!=='undefined'},confirmed:function(ref){ref.selectPrice()},showFlexiblePricePopup:function(){$('ps_price_msg').innerHTML=$('custom_flexible_amount').value<this.customVC.minAmount?this._tx('For this payment method the minimum amount is #s').replace('#s',this.customVC.minAmountReal+' '+this.customVC.currencyCode):this._tx('For this payment method the maximum amount is #s').replace('#s',this.customVC.maxAmountReal+' '+this.customVC.currencyCode);$('ps_new_window_popup').show()},hideFlexiblePricePopup:function(){$('ps_new_window_popup').hide()},initRecentPaymentCheck:function(){if(this.isRecentPaymentCheckActive&&this.activeRecentPaymentChecks.indexOf(this.system)==-1){var currentSystem=this.system;this.listenForPayment(this,currentSystem);if(window.PWEyeTracker){window.PWEyeTracker.trackEvent('recent_payment_check','start',currentSystem)}this.activeRecentPaymentChecks.push(this.system)}},selectPrice:function(e){if(e){if(this.appendPaymentForm&&!$(this.priceFormId)){e.target.stopObserving()}Event.stop(e)}if(!this.validateForm()){return}this.initRecentPaymentCheck();if(this.getPrice()=='custom_flexible'){if(($('custom_flexible_amount').value<this.customVC.minAmount||$('custom_flexible_amount').value>this.customVC.maxAmount)){this.showFlexiblePricePopup();return}else{this.hideFlexiblePricePopup()}}this.callOnSelectPriceListeners();if(this.getPrice()!=''){if(this.customCommission&&this.confirmFormDefined()){confirmForm.open(this);return false}this.currentPaymentStep='payment';if($(this.priceFormId)){this.showPsWidgetInNewWindow()}else{if(this.loginRequired&&this.loginFormDefined()){loginForm.openSignupFormQuick(this.getPrice());return}this.showPsWidgetInIframe()}}},isPriceRecurring:function(priceId){var html=$$('#price_'+priceId+'_')[0].innerHTML;var result=html.match(/recurring/i);return result===null?false:true},getController:function(p){var extraParams='';var action=this.clickAction;if(p){var priceData=this.getPriceData(p);if(priceData){if(priceData['ag_type']){extraParams+='&good='+priceData['ag_type']}if(priceData['flow']){extraParams+='&flow='+priceData['flow']}}if(p=='custom_flexible'){extraParams+='&amount='+$('custom_flexible_amount').value;extraParams+='&customvc=1';extraParams+='&currencyCode='+this.customVC.currencyCode;action='flexible'}if(this.system=='epinpaymentsystem'){$$('select#select_currency option').each(function(obj){if(obj.selected){extraParams+='&epinCurrCode='+obj.value}})}if($('widget_email_field_input')){extraParams+='&email='+encodeURIComponent($('widget_email_field_input').value)}if(this.couponsFieldAvailable&&$('coupon_code')&&this.couponChecked&&!this.isMobileSystem()){extraParams+='&coupon='+encodeURIComponent($('coupon_code').value||this.couponValue)}}return ControllersUrl+this.system+'/'+action+'?'+UrlParams+extraParams},openPaymentwallPopup:function(name){var popupName=name||'paymentwallPopup';var dimensions=this.getWidgetCustomDimensions();var result=window.open('about:blank',popupName,'scrollbars=yes,resizable=yes,location='+this.getWidgetCustomLocation()+',width='+dimensions[0]+',height='+dimensions[1]);return result},showPsWidgetInNewWindow:function(target){var target=target||null;var p=this.getPrice();if(this.showPsInNewWindow||this.nonIframePsInPopup){var paymentMethodPopup=null;var popupName='paymentwallPopup'+skey;try{paymentMethodPopup=this.openPaymentwallPopup(popupName)}catch(e){this.handleNoPaymentwallPopupException()}if(paymentMethodPopup){$(this.priceFormId).target=popupName;paymentMethodPopup.focus();this.onClientSideCallbackEvent('paymentProcessingStart');var ref=this;var paymentMethodPopupInterval=window.setInterval(function(){try{if(paymentMethodPopup==null||paymentMethodPopup.closed){window.clearInterval(paymentMethodPopupInterval);if(!ref.paymentMethodPopupSuccessReceived){ref.onPaymentMethodPopupClosed()}}}catch(e){}},1000)}}if(target!='_self'){this.showPriceMessage()}if(this.flexibleAmount){var priceData=this.getPriceData(p);if(priceData&&priceData['flexible']&&$(this.flexibleAmountContainer)){$(this.flexibleAmountContainer).setValue(priceData['amount']);$(this.flexibleCurrencyContainer).setValue(priceData['cu_code'])}}this.appendAdditionalParamsToForm();$(this.priceFormId).action=this.getController(p);if(target!=null){$(this.priceFormId).target=target}if(undefined!=$('handleRefreshWidget')&&$('handleRefreshWidget').value==1){handleRefreshWidget()}else{this.submitPriceForm()}$(this.buttonId).blur()},handleNoPaymentwallPopupException:function(){},paymentMethodPopupSuccess:function(data){},submitPriceForm:function(){$(this.priceFormId).submit()},showPsWidgetInIframe:function(){var p=this.getPrice();this.changeStep();var parameters=this.getPsParameters();if(this.useAjaxToGetIframeContent()){var ref=this;var controller=this.getController(p);if($(ref.backButtonId)){$(ref.backButtonId).stopObserving()}try{if(this.showPreloaderOnPsLoadInSameWindow||false){this.showPaymentForm('<div id="ps_widget_preloader_widget"></div>')}}catch(error){}new Ajax.Request(controller,{method:ref.getAjaxMethod(),parameters:parameters,onSuccess:function(t){try{var c=t.responseText;if(c.length<220&&c.search("mobiamo_price_unavailable")>0&&ref.pricesView!="p10"){if(!$("mobiamo_price_unavailable")){if(ref.pricesView=="mobile"){$(ref.contentId).insert({before:c})}else{$("card_but").insert({before:c})}}}else{ref.showPsWidgetInIframeContent(c);if($(ref.backButtonId)){ref.listenBackButton()}}}catch(e){}}})}else{var c='<iframe src="'+this.getController(p)+'&'+$H(parameters).toQueryString()+'" id="new_window_ps_container" width="100%" height="500" frameborder="0" allowtransparency="true"></iframe>';this.showPsWidgetInIframeContent(c)}},initRedirectToPsNewWindow:function(timeout){window.setTimeout(this.redirectToPsNewWindow.bind(this),timeout)},redirectToPsNewWindow:function(){this.showPsWidgetInNewWindow('_self')},useAjaxToGetIframeContent:function(){return!this.showPsInSameWindow||this.showPsInSameWindow!='in_iframe'},getAjaxMethod:function(){return'get'},getPsParameters:function(){var p=this.getPrice();var parameters={p:p,'clickproperty':this.clickProperty};if(this.flexibleAmount){var priceData=this.getPriceData(p);if(priceData&&priceData['flexible']){parameters['amount']=priceData['amount'];parameters['currencyCode']=priceData['cu_code']}}return this.appendAdditionalParamsToHash(parameters)},setClickProperty:function(type){this.clickProperty=type},showPsWidgetInIframeContent:function(c){var ref=this;ref.showPaymentForm(c);ref.iframePaymentMethodOpened=true;this.onClientSideCallbackEvent('paymentProcessingStart');if(ref.isHidePreloaderOnPsWidgetLoad()){var contentIframes=ref.getIframeList();if(contentIframes&&contentIframes.length>0){contentIframes.each(function(frame){var iframeIsLoading=false;try{iframeIsLoading=(frame.readAttribute('src')!='')}catch(e){}if(iframeIsLoading){ref.isIframeLoaded=false;frame.observe('load',function(){ref.onIframeLoaded()})}else{ref.onIframeLoaded()}})}else{ref.onIframeLoaded()}contentIframes=null}},getIframeList:function(){return $(this.contentId).select('iframe')},isHidePreloaderOnPsWidgetLoad:function(){return this.hidePreloaderOnPsWidgetLoad},onIframeLoaded:function(){if($('ps_widget_preloader'))$('ps_widget_preloader').hide();if(this.opt.clientCallbacks){this.onWidgetSizeChanged()}},onWidgetSizeChanged:function(){var dimensions={'height':document.getElementById('ppage').offsetHeight+'px','width':document.getElementById('ppage').offsetWidth+'px'};try{var targetWindow=((window.parent===window.self)&&window.opener)?window.opener:window.parent;if(this.opt.clientCallbacks.onWidgetSizeChanged){targetWindow.postMessage('PaymentwallWidgetResizeHandler('+Object.toJSON(dimensions)+')','*')}else if(this.opt.clientCallbacks=='v2'){var eventData={'event':'widgetSizeChanged','data':dimensions};targetWindow.postMessage(Object.toJSON(eventData),'*')}}catch(e){}},onPaymentMethodPopupClosed:function(){this.hidePriceMessage();this.onClientSideCallbackEvent('paymentProcessingEnd')},onClientSideCallbackEvent:function(eventName,data){if(this.opt.clientCallbacks&&(this.opt.clientCallbacks=='v2')){data=data||false;var eventData={'event':eventName};if(data){eventData.data=data}try{var targetWindow=((window.parent===window.self)&&window.opener)?window.opener:window.parent;targetWindow.postMessage(Object.toJSON(eventData),'*')}catch(e){}}},getPrice:function(){var price=this.getCheckedPrice();if(price!=null){return price.pluck('value')}else{return this.prices[this.system][0]['id']}},getPriceData:function(priceId){for(var i in this.prices[this.system]){if(priceId==this.prices[this.system][i]['id']){return this.prices[this.system][i]}}return false},open:function(e,system,restoreForm){if(e){Event.stop(e)}this.selectedSystem=system;if(isGatewayReplicasInCountriesEnabled&&this.gatewayLocalBrands.indexOf(system)!=-1){system='gateway'}this.hidePriceMessage();this.updateTitle(system);if(system!=this.system||restoreForm||(isGatewayReplicasInCountriesEnabled&&this.selectedSystem!=this.previousSystem)){this.updatePricePoints(system)}this.listenRows();this.listenBuyButtonClick();this.switchTab(system||this.system);if(e!==false){if(this.hidePricesBeforeSelection){$(this.contentId).show();if($('pay_methods_container'))$('pay_methods_container').hide();this.showBackButton()}else{this.hideBackButton()}}if(this.iframePaymentMethodOpened){this.iframePaymentMethodOpened=false;this.onClientSideCallbackEvent('paymentProcessingEnd')}this.afterOpen(e)},reload:function(){this.open(false,this.system,true)},show:function(content){$(this.contentId).update(content)},showPaymentForm:function(content){this.showBackButton();if(this.appendPaymentForm){if($('card_but')){$('card_but').hide()}if($(this.recurringMessageId)){$(this.recurringMessageId).hide()}this.hideCustomFieldsOnFormAppend();if($('ps_appended_form_container')){$('ps_appended_form_container').update(content)}else{$(this.contentId).insert('<div id="ps_appended_form_container">'+content+'</div>')}}else if(this.opt.showIframePsInPopupLayer){if(this.opt.showIframePsInPopupLayer.not&&this.opt.showIframePsInPopupLayer.not.indexOf(this.system)>=0){this.showContent(content)}else{this.showContentInPopupLayer(content)}}else{this.showContent(content)}},showContentInPopupLayer:function(content){if(!$('ps_form_popup_layer')){this.buildPsFormPopupLayer()}$('ps_form_popup_layer_content').update(content);$('ps_form_popup_layer').show()},buildPsFormPopupLayer:function(){var h='<div class="popup" style="top: 10px; display: none;" id="ps_form_popup_layer">';h+='<div class="in">';h+='<a class="close" onclick="$(\'ps_form_popup_layer\').hide()" href="javascript:void(0);">Cancel</a>';h+='<div id="ps_form_popup_layer_content"></div>';h+='</div>';h+='</div>';$(this.contentId).insert(h)},changeStep:function(){if(this.hidePaymentMethodsAfterSelection||this.hideAllAfterSelection){if(this.hidePaymentMethodsAfterSelection!='no'){if($('pay_methods_container'))$('pay_methods_container').hide()}$(this.priceTableCntId).hide();$('card_but').hide();this.showBackButton();if($$('.step.step1').length){$$('.step.step1')[0].hide()}if($$('.step.step2').length){$$('.step.step2')[0].hide()}if($$('.step.step3').length){$$('.step.step3')[0].hide()}}this.afterChangeStep()},afterChangeStep:function(){},showContent:function(content){this.show(content)},listenBackButton:function(){var ref=this;if($(this.backButtonId)){$(this.backButtonId).observe('click',function(e){e.stop();ref.open(null,ref.system,true);ref.hideBackButton();if($(ref.backButtonIndexId)){$(ref.backButtonIndexId).show()}if($('ps_step_1')){$('ps_step_1').show()}if($('ps_step_2')){$('ps_step_2').show()}if($('ps_step_3')){$('ps_step_3').show()}ref.currentPaymentStep='selectPackage'})}},showBackButton:function(){if($(this.backButtonId)){$(this.backButtonId).show();if(this.hidePricesBeforeSelection){try{$(this.priceId).select('.first').each(function(r){r.hide()})}catch(e){};if($('card_but')){$('card_but').hide()}}if($(this.backButtonIndexId)){$(this.backButtonIndexId).hide()}}},hideBackButton:function(){if($(this.backButtonId)){$(this.backButtonId).hide();if(this.hidePricesBeforeSelection){if($('pay_methods_container'))$('pay_methods_container').show();$(this.contentId).hide()}if(this.hidePaymentMethodsAfterSelection){if($('pay_methods_container'))$('pay_methods_container').show()}if($('selected_product')){$('selected_product').hide()}}},hideCustomFieldsOnFormAppend:function(){},updateTitle:function(system){var title=this.titles.paymentSystem?this.titles.paymentSystem:'Use #s to buy #c';$('paymentSystemTitle').update(this._tx(title).replace('#s',this.paymentSystems[system]['name']).replace('#c',this.currency))},updatePricePoints:function(system){var html='';if(system=='smscoin'&&this.smsOperators&&this.priceView!='mobile'){this.show(smsCoinPw.getHtmlForPaymentWall());smsCoinPw.listenOperatorSelect()}else{html=this.wrapPricePoints(this.wrapPricePointsSelect(this.buildPricePoints(system),system),system);if(this.showMessagesUnderButton){html+=this.buildMessages(system)}if(this.opt.askEmailInWidget){html+=this.buildEmailField()}if(this.pricesView!='mobile'){if(this.couponsFieldAvailable&&!this.isMobileSystem(system)){html+=this.buildCouponField()}html+='<div id="card_but" class="button">';if(system!='googlecheckout'){var buttonTitle=this.titles.buyButton?this._tx(this.titles.buyButton).replace('%s',this.currency):(this._tx('Buy #c')=='Buy #c'?this._tx('Buy')+' '+this.currency:this._tx('Buy #c').replace('#c',this.currency));html+='<a class="button but2 left" href="#" id="ps_psb">'+buttonTitle+'</a>'}else{html+='<a class="floatl" href="#" id="ps_psb" style="width:180px;"><img src="'+BaseUrl+'images/googlecheckout_button.png"></a>'}if((this.paymentSystems[system]['new_window']==1||this.showPsInNewWindow)&&!this.showPsInSameWindow){html+='<b class="clearb"></b><p class="small">'+this._tx('Opens new window')+'</p>'}if(system=='paypal'&&this.showPaypalButtonBranding){html+='<table class="branding"><tr>';html+='<td><a class="logo" target="_blank" href="http://paymentwall.com">Paymentwall Inc.</a></td>';html+='<td><span>'+this.paypalButtonBrandingNotice+'</span></td>';html+='</tr></table>'}html+='<b class="clearb"></b></div>'}if(!(this.showMessagesUnderButton)){html+=this.buildMessages(system)}html+='<b class="clearb"></b>';this.show(html);if(this.couponsFieldAvailable&&!this.isMobileSystem(system)){this.observeCouponClick()}this.afterUpdatePricePoints(system);if(this.isCustomVcInputAvailable(system)){$('custom_flexible_amount').observe('keyup',this.updateCurrencyCost.bind(this));$('custom_flexible_amount').observe('keypress',this.checkInput.bind(this));if($(this.customVcAmountPriceInputId)){$(this.customVcAmountPriceInputId).observe('keyup',this.updateCustomVcAmountByPrice.bind(this));$(this.customVcAmountPriceInputId).observe('keypress',this.checkInput.bindAsEventListener(this,[44,46]));$(this.customVcAmountPriceViewId).observe('click',this.showCustomVcAmountPriceInput.bind(this))}}}},observeCouponClick:function(){if(this.couponsFieldAvailable&&!this.isMobileSystem()){if($('coupon_code_submit')){if(this.getCheckedPrice()&&!this.couponLastError){$('coupon_code_submit').removeClassName('disabled');$('coupon_code_submit').observe('click',this.checkCouponAjax.bind(this,this.getPrice()));var ref=this;$$('.pricepoint_row input[type=radio]').invoke('observe','change',function(){$('coupon_code_submit').stopObserving('click');$('coupon_code_submit').observe('click',ref.checkCouponAjax.bind(ref,ref.getPrice()))});this.applyCoupon()}else{$('coupon_code_submit').addClassName('disabled')}}this.couponChecked=false}return false},afterCheckCouponSuccess:function(priceId,price){$('coupon_code_submit').update('Clear');$('coupon_code_submit').stopObserving('click');$('coupon_code_submit').observe('click',this.checkCouponEdit.bind(this,priceId));this.couponChecked=true;var html='';html+='<span class="discounted_price coupon">'+this.getPriceData(priceId).price+'</span>&nbsp;';html+='<b>'+price.discounted_price_amount+'</b>';var prefix=this.getPriceData(priceId).prefix?this.getPriceData(priceId).prefix:'';$('price_'+prefix+priceId+'_').down('.price').update(html);if((this.showPsAfterSelectingPsOnlyInSameWindow&&!this.paymentSystems[this.system].new_window)||this.showPsAfterSelectingPs){this.selectPrice()}},isCustomVcInputAvailable:function(system){return this.paymentSystems[system].editable&&this.customVC&&((!this.customVC.onlyForPs)||(this.customVC.onlyForPs.indexOf(system)>=0))},afterCheckCouponFailed:function(response){var ref=this;var html='';html+='<span class="rounded_msg action">'+response.message+'</span>';if(response.error!=6){html+='<a href="javascript:void(0);" class="rounded_button " id="coupon_code_submit">Try again</a>'}else{html+='<a href="javascript:void(0);" class="rounded_button disabled" id="coupon_code_submit">Try later</a>'}$('coupon_code_div').update(html);$('coupon_code_submit').stopObserving('click');this.couponError=true;if(response.error!=6){$('coupon_code_submit').observe('click',function(){$('coupon_code_submit').stopObserving('click');$('coupon_code_div').update(ref.updateCouponField());$('coupon_code_submit').observe('click',ref.checkCouponAjax.bind(ref,ref.getPrice()))})}else{this.couponLastError=true}},updateCouponField:function(){var html='';if(this.couponLastError){html+='<span type="text" class="rounded_msg action">No more attempts left to provide the valid code. Please, try again later.</span>';html+='<a href="javascript:void(0);" class="disabled rounded_button" id="coupon_code_submit">Try later</a>'}else{html+='<input type="text" class="rounded_input" placeholder="I have my coupon" id="coupon_code">';html+='<a href="javascript:void(0);" class="rounded_button" id="coupon_code_submit">Apply</a>'}return html},checkCouponEdit:function(priceId){this.clearCoupon();var html='';if(this.getPriceData(priceId).discounted_price){html+='<span class="discounted_price coupon">'+this.getPriceData(priceId).discounted_price+'</span>&nbsp;'}html+='<b>'+this.getPriceData(priceId).price+'</b>';var prefix=this.getPriceData(priceId).prefix?this.getPriceData(priceId).prefix:'';$('price_'+prefix+priceId+'_').down('.price').update(html);if((this.showPsAfterSelectingPsOnlyInSameWindow&&!this.paymentSystems[this.system].new_window)||this.showPsAfterSelectingPs){this.selectPrice()}},buildCouponField:function(){var html='';html+='<div style="margin-bottom:20px" id="coupon_code_div">';html+=this.updateCouponField();html+='</div>';return html},removeCouponDiscountOnChange:function(){var discountedPriceByCoupon=$$('.coupon')[0];if(discountedPriceByCoupon){this.checkCouponEdit($(this.checkedRow).down('input[type=radio]').value)}},buildMessages:function(system){var html='';if(system=='cherrycredits'){html+='<p class="small" style="text-align:left;">*CC = Cherry Credits</p>'}if(system=='coinbasebitcoin'){html+='<p style="text-align:left;"><a href="https://bitcoin.org/en/" target="_blank"><i>'+this._tx('What is Bitcoin?')+'</i></a></p>'}if(system=='epinpaymentsystem'){html+='<p style="text-align:left;"><a href="http://paymentwall.com/distribution" target="_blank"><i>'+this._tx("Don\'t have Mint yet? Click here to buy!")+'</i></a></p>'}if(system=='paypal'&&this.showPaypalEcheckNotice){var echeckPhrase='When using eCheck, it usually takes between #numberFrom and #numberTo business days for it to clear and you to '+(this.useSubscriptions?'upgrade':'get the')+' #c.';html+='<p class="small" style="text-align:left;">'+this._tx(echeckPhrase).replace('#c',this.currency).replace('#numberFrom',3).replace('#numberTo',8)+'</p>'}if(system=='eprepagcard'){html+='<p style="text-align:left;"><a href="http://www.e-prepag.com.br/busca-pdv.php" target="_blank"><i>'+this._tx("Don't have a pin? Find a sales outlet!")+'</i></a></p>'}if(this.paymentSystems[system]['protect_customers_law']){html+=this.buildProtectCustomersLawMessage()}if(this.recurringSystems[system]&&this.recurringSystems[system].recurring_price_present){html+=this.buildRecurringMessage(system)}return html},buildProtectCustomersLawMessage:function(){var html='';html+='<p class="small">* ';html+=this._tx(this.titles.protectCustomersLaw?this.titles.protectCustomersLaw:'Your credit card will be charged in USD, the final price may vary.');html+='</p>';return html},buildRecurringMessage:function(system){return'<p class="small'+(this.recurringSystems[system].onetime_price_present?' recurring':'')+'" id="'+this.recurringMessageId+'">'+this._buildRecurringMessage(system)+'</p>'},_buildRecurringMessage:function(system){var html='';if(this.recurringSystems[system].onetime_price_present){html+='<b>'+this.getRecurringBillingPlansMark()+this._tx('Recurring billing for marked subscription plans only.')+'</b><br />'}if(this.recurringSystems[system].is_mobile==true&&paymentSystemsRecurringMessagesSets['mobile']){html+=paymentSystemsRecurringMessagesSets['mobile']}else{html+=paymentSystemsRecurringMessagesSets['default']}html+=this.buildTrialMessage(system);return html},getRecurringBillingPlansMark:function(){return''},buildEmailField:function(){h='<div id="widget_email_field" class="widget_email_field">';h+='<input name="email" type="input" placeholder="'+this._tx('Your email')+'" id="widget_email_field_input" class="widget_email_field_input" />';h+='<div id="widget_email_field_error" class="widget_email_field_error widget_field_error">'+this.opt.errors.wrongEmail+'</div>';h+='</div>';return h},afterUpdatePricePoints:function(system){var ref=this;if(system=='webmoney'){if($('select_currency')){$('select_currency').observe('change',function(){var selectedCurrency=$F('select_currency');ref.webmoneyCurrency=selectedCurrency;ref.prices[system]=wmPrices[selectedCurrency];ref.open(null,'webmoney',true)})}}if(system=='epinpaymentsystem'){if($('select_currency')){$('select_currency').observe('change',function(){var selectedCurrency=$F('select_currency');ref.epinCurrency=selectedCurrency;ref.prices[system]=epinPrices[selectedCurrency];ref.open(null,'epinpaymentsystem',true)})}}},buildTrialMessage:function(system){var html='';var trialCounter=0;var currencyName,nextPrice;for(var p in this.prices[system]){p=parseInt(p);if(Math.floor(p)==p){price=this.prices[system][p];if(price['trial']){trialCounter++;html+='<br />'+this.buildTrialCounter(trialCounter)+' - ';nextPrice=this.prices[system][price['next']];currencyName=nextPrice['currency_name']?nextPrice['currency_name']:this.currency;html+=this._tx('When your trial ends and you don\'t cancel it, your subscription plan will change to #p for #c #s.').replace('#p',nextPrice['price']).replace('#s',currencyName).replace('#c',nextPrice['virtual_currency'])}}}return html},buildTrialCounter:function(trialCounter){return'<sup>'+trialCounter+'</sup>'},afterOpen:function(event){if(this.isShowPsAfterCheckPrice()){if($('card_but')){$('card_but').hide()}}if(event&&(this.showPsAfterSelectingPsOnlyInSameWindow!='onlyOnPaymentStep'||this.currentPaymentStep!='selectPackage')&&(this.showPsAfterSelectingPs||(this.showPsAfterSelectingPsOnlyInSameWindow&&!this.paymentSystems[this.system].new_window))){if(this.showPsAfterSelectingPs=='confirming_new_window'&&this.paymentSystems[this.system].new_window){this.confirmNewWindow()}else{this.selectPrice()}}this.applyCoupon()},isShowPsAfterCheckPrice:function(){return this.showPsAfterCheckPrice||(this.showPsAfterCheckPriceOnlyInSameWindow&&!this.paymentSystems[this.system].new_window)},afterCheckPrice:function(priceId){if(priceId=='custom_flexible'){return}if(this.useLastPriceAsDefaultOnSelectingPs){this.lastPriceIndex=this.findPriceIndex(priceId,this.prices[this.system])}if(this.hidePricesBeforeSelection||this.isShowPsAfterCheckPrice()){if(this.showPsAfterCheckPrice=='confirming_new_window'&&this.paymentSystems[this.system].new_window){this.confirmNewWindow()}else{this.selectPrice()}}},confirmNewWindow:function(){this.changeStep();$('card_but').show()},buildPricePoints:function(system){var html='<table cellspacing="0" cellpadding="0" border="0" class="package'+(this.useSubscriptions?' subscription2':'')+'" id="ps_price">';var price,p,currencyName;var trialCounter=0;var firstCellPresent=false;var pricepointIterator=0;for(p in this.prices[system]){p=parseInt(p);if(Math.floor(p)==p){pricepointIterator++;price=this.prices[system][p];if(!price['hide']){html+='<tr id="price_'+(price['prefix']?price['prefix']:'')+price['id']+'_" class="pricepoint_row pricepoint_row'+(pricepointIterator)+((price['default']==1)?' pricepoint_over':'')+(price['product_id']?' product_'+price['product_id']:'')+'">';if(this.recurringSystems[system]&&this.recurringSystems[system].recurring_price_present&&this.recurringSystems[system].onetime_price_present){html+='<td class="first '+(price.recurring?' recurring':'')+'">';firstCellPresent=true;if(price.recurring){html+='<div title="Recurrent Billing">Recurrent Billing</div>'}html+='</td>'}html+='<td'+(!firstCellPresent?' class="first"':'')+'><input type="radio" value="'+price['id']+'" name="p"'+((price['default']==1)?' checked':'')+' id="price_'+(price['prefix']?price['prefix']:'')+price['id']+'" /></td>';html+='<th><strong>'+price['virtual_currency']+'</strong>&nbsp;';currencyName=price['currency_name']?price['currency_name']:this.currency;if(price['trial']){trialCounter++;currencyName+=this.buildTrialCounter(trialCounter)}html+='<span class="vc_name_container">';html+=this._tx('#c for #amount_formatted').replace('#amount_formatted','').replace('#c','<span class="vc_name">'+currencyName+'</span>');html+='</span>';if(this.displaySubscriptionMonthlyPrices){var virtual=parseFloat(price['period_length']);if(virtual!=1){html+='<span class="price_total_payment">';html+='<br />';html+=this._tx('Total payment')+' '+price['price'];html+='</span>'}}html+='</th>';html+='<td class="price">';if(this.displaySubscriptionMonthlyPrices){if(price['discounted_price_single']!=price['price_single']){html+='<span class="discounted_price">'+price['discounted_price_single']+(price['period_type']==''?'':' / ')+price['period_type']+'</span>&nbsp;'}html+='<b>'+price['price_single']+(price['period_type']==''?'':' / ')+price['period_type']+'</b>'}else{if(price['discounted_price']){html+='<span class="discounted_price">'+this.supPricePoint(price['discounted_price'])+'</span>&nbsp;'}html+='<b>'+this.wrapPricePoint(price);html+='</b></td>'}html+='<td class="bonus">';if(price['comment']){html+=price['comment']+'&nbsp;'}if(price['promo']){html+=price['promo']+'&nbsp;'}html+='</td>';html+='<td class="tag last">';if(price['tag']=='best'){html+='<div class="value">'+this._tx('Best Value')+'</div>'}else if(price['tag']=='popular'){html+='<div class="popular">'+this._tx('Most Popular')+'</div>'}else{html+='&nbsp;'}html+='</td>';html+='</tr>'}}}if(this.isCustomVcInputAvailable(system)){html+='<tr id="price_flexible_custom_"><td class="first"><input type="radio" name="p" value="custom_flexible" id="price_flexible_custom"></td>';html+='<td style="padding-left: 5px;" class="other_amount">';html+='<strong><input type="text" name="" id="custom_flexible_amount" autocomplete="off"></strong> ';html+='<span class="vc_name_container">';html+=this._tx('#c for #amount_formatted').replace('#amount_formatted','').replace('#c','<span class="vc_name">'+currencyName+'</span>')+'</td>';html+='</span>';html+='<td class="price"><b id="'+this.customVcAmountPriceViewId+'">-</b></td><td class="bonus"></td><td class="tag last">&nbsp;</td>';html+='</tr>'}html+='</table>';return html},wrapPricePoint:function(price){return this.supPricePoint(price['price'])},supPricePoint:function(price){if(this.pricePointsSupFractionalPart){var a=price.split(".");var b=a[1].split(" ");b='<b>'+(a[0]+"."+'<sup>'+b[0]+'</sup>'+" "+b[1])}else{b=price}return b},wrapPricePoints:function(html,system){var wrapper='';if((this.paymentSystems[system]['new_window']==1||this.showPsInNewWindow)&&!this.showPsInSameWindow){wrapper='<form action="" target="'+((!this.showPsInNewWindow&&!this.nonIframePsInPopup)?'_blank':'paymentwallPopup')+'" id="ps_price_form" method="post">';if(this.flexibleAmount){wrapper+='<input type="hidden" name="amount" id="flexible_amount" value="0" />';wrapper+='<input type="hidden" name="currencyCode" id="flexible_currency" value="" />'}}html=wrapper+html;if((this.paymentSystems[system]['new_window']==1||this.showPsInNewWindow)&&!this.showPsInSameWindow){html+='</form>'}html='<div id="'+this.priceTableCntId+'">'+html+'</div>';return html},wrapPricePointsSelect:function(html,system){var wrapper='';var ref=this;if(system=='webmoney'){wrapper+='<div class="selector"><div class="selector_text">'+ref._tx('Select Webmoney currency')+':</div>';wrapper+='<select class="floatl" id="select_currency" name="wm_currency">';wmPricesSupported.each(function(item){if(item==ref.webmoneyCurrency){wrapper+='<option value="'+item+'" selected>'+item+'</option>'}else{wrapper+='<option value="'+item+'">'+item+'</option>'}});wrapper+='</select>';wrapper+='<b class="clearb"></b></div>'}if(system=='epinpaymentsystem'){if(typeof epinPricesSupported!=='undefined'){wrapper+='<div class="selector"><div class="selector_text">'+ref._tx('Select e-PIN currency')+':</div>';wrapper+='<select class="floatl" id="select_currency" name="epin_currency">';epinPricesSupported.each(function(item){for(var prop in ref.prices['epinpaymentsystem']){var firstItem=ref.prices['epinpaymentsystem'][prop];break}if(item==ref.epinCurrency||firstItem.cu_code==item){wrapper+='<option value="'+item+'" selected>'+item+'</option>'}else{wrapper+='<option value="'+item+'">'+item+'</option>'}});wrapper+='</select>';wrapper+='<b class="clearb"></b></div>'}}html=wrapper+html;return html},showPriceMessage:function(){var title=this.titles.popup?this.titles.popup:'Please proceed in the #s window to complete transfer of #c to your account';var adding=this.titles.popupAdditional?this.titles.popupAdditional:'';$(this.priceMsgId).update(this._tx(title).replace('#s',this.paymentSystems[this.system]['name']).replace('#c',this.currency)+adding);$(this.newWindowPopupId).show();if(this.deactivateWidgetOnNewWindowOpened){if(!$('ps_bg')){$('ppage').insert('<div id="ps_bg" class="fade" style="display:none;top:0"><div class="fadein"></div></div>');$(this.newWindowPopupId).select('a.close')[0].observe('click',this.hidePriceMessage.bind(this))}$('ps_bg').show()}document.activeElement.blur()},hidePriceMessage:function(){$(this.newWindowPopupId).hide();if($('ps_bg')){$('ps_bg').hide()}},initPager:function(){if(($(this.id+'_prev'))&&($(this.id+'_next'))){if(this.total<this.visible&&this.pricesView=='p10'){$(this.id+'_next').className='payarr payn'}if(this.total>this.visible){$(this.id+'_prev').show();$(this.id+'_next').show();$(this.id+'_prev').observe('click',this.paginate.bindAsEventListener(this,-1));$(this.id+'_next').observe('click',this.paginate.bindAsEventListener(this,1))}}},paginate:function(e,s){Event.stop(e);var p=this.page+s;var last=Math.ceil(this.total/this.visible);if(p>0&&p<=last){if(typeof(this.systems)=='undefined'){this.systems=$(this.container).select('div')}var ref=this;this.systems.each(function(d,i){if(i>=(p-1)*ref.visible&&i<Math.min(p*ref.visible,ref.total)){$(d).show()}else{$(d).hide()}});this.page=p;$(this.id+'_prev').className=p==1?'payarr payp':'payarr payps';$(this.id+'_next').className=p==last?'payarr payn':'payarr payns'}},switchTab:function(system){if(isGatewayReplicasInCountriesEnabled){if($('tab_'+this.previousSystem)){$('tab_'+this.previousSystem).removeClassName('sel')}this.previousSystem=this.selectedSystem;this.system=system;if($('tab_'+this.selectedSystem)){$('tab_'+this.selectedSystem).addClassName('sel')}}else{if($('tab_'+this.system)){$('tab_'+this.system).removeClassName('sel')}this.system=system;if($('tab_'+this.system)){$('tab_'+this.system).addClassName('sel')}}this.trackGoogleAnalyticsEvent('payment_system_switched')},getAutoVisible:function(){if(this.pricesView=='p10'){return Math.floor($(this.container).getWidth()/121)}return Math.floor($(this.container).getWidth()/111)},togglePriceOver:function(ref){var refId=this.id.substr(0,this.id.length-1);if(!$(refId).checked){this.toggleClassName(ref.checkedPriceToggledClass||'pricepoint_over')}},checkPrice:function(ref){if(ref.checkedRow&&$(ref.checkedRow)){if(ref.uncheckedPriceClassName){$(ref.checkedRow).className=ref.uncheckedPriceClassName}else{$(ref.checkedRow).removeClassName('pricepoint_over')}}else if($('coupon_code_submit')){ref.observeCouponClick()}var refId=this.id.substr(0,this.id.length-1);if(ref.couponsFieldAvailable){if(ref.couponError&&!ref.isMobileSystem()){$(refId).click();$('coupon_code_submit').stopObserving('click');if(!ref.couponLastError){$('coupon_code_div').update(ref.updateCouponField());$('coupon_code_submit').observe('click',ref.checkCouponAjax.bind(ref,ref.getPrice()))}}ref.removeCouponDiscountOnChange();$(refId).click()}else{$(refId).checked=true}ref.checkedRow=this.id;if(ref.checkedPriceClassName){this.className=ref.checkedPriceClassName}else{this.addClassName('pricepoint_over')}ref.trackGoogleAnalyticsEvent('price_checked');ref.afterCheckPrice($(refId).value)},getParamsForGoogleAnalyticsEvent:function(event){var price=this.getPriceData(this.getPrice());var system=this.system;var productName=price['virtual_currency']+' '+(price['currency_name']?price['currency_name']:this.currency);return{productName:productName,paymentSystemName:this.paymentSystems[this.system]['name'],lang:Language}},_tx:function(source){if('undefined'!=typeof(_string_table)&&undefined!=_string_table[source]){return _string_table[source]}else{return source}},getCurrentPriceId:function(){return $('price_'+this.getPrice()).getValue()},updateCustomVcAmountByPrice:function(e){var realAmountText=$(this.customVcAmountPriceInputId).value;var realAmount=parseFloat(realAmountText.replace(',','.'))||0;var subCentPart=realAmount-this.roundPrecision(realAmount,2);if(subCentPart!=0){$(this.customVcAmountPriceInputId).value=this.fomartNumberUsingFormat(this.roundPrecision(realAmount,2),this.customVC.numberFormatFloat)}var vcAmount=this.calculateVirtualCurrencyAmount(realAmount);if(vcAmount>=this.customVC.minAmount&&vcAmount<=this.customVC.maxAmount){$('custom_flexible_amount').value=vcAmount;this.afterUpdateCurrencyCost(vcAmount);if($('card_but')&&this.isShowPsAfterCheckPrice())$('card_but').show()}else if(false&&vcAmount>0){if($('card_but')&&this.isShowPsAfterCheckPrice())$('card_but').show();var precision=(this.customVC.minAmount/this.customVC.vcRate)>1?1:100;$(this.customVcAmountPriceInputId).value=vcAmount>this.customVC.maxAmount?this.customVC.maxAmountReal:(Math.round(precision*this.customVC.minAmount/this.customVC.vcRate)/precision)}else if(true||vcAmount==0){if($('card_but')&&this.isShowPsAfterCheckPrice())$('card_but').hide();$('custom_flexible_amount').value='';this.afterUpdateCurrencyCost(0)}},hideCustomVcAmountPriceInput:function(){$(this.customVcAmountPriceInputContainerId).hide();$(this.customVcAmountPriceViewId).show()},showCustomVcAmountPriceInput:function(){$(this.customVcAmountPriceViewId).hide();$(this.customVcAmountPriceInputContainerId).show();$(this.customVcAmountPriceInputId).focus()},roundPrecision:function(number,precision){return Math.round(number*Math.pow(10,precision))/Math.pow(10,precision)},fomartNumberUsingFormat:function(number,format){var result=number;if(format){var integerPart=Math.floor(number);var decimalPart=Math.round((number-Math.floor(number))*100);if(decimalPart==0)decimalPart='00';result=format.replace('%decimal%',decimalPart);result=result.replace('%integer%',integerPart)}return result},calculateVirtualCurrencyCost:function(vcAmount){if(this.customVC.factorizeBasedOnPricePoints){if(this.customVC.factorizeBasedOnPricePoints=='linear_bonus'){var prices=this.prices[this.system];var rate=this.customVC.vcRate;if(this.system=='webmoney'){prices=wmPrices[this.customVC.wmCurrencyCode];rate=this.customVC.wmCurrencyRate}var result=this.factorizeAmountByBaseAmounts(vcAmount,prices,'virtual_currency_int','amount',1);if(result.factorizationIndexes.length>0){var basePrice=prices[result.factorizationIndexes[0]];if(basePrice.ap_discount_type=='percentage_bonus'&&basePrice.discount){rate=rate*(1+basePrice.discount/100)}}return result.amount+this.calculateVirtualCurrencyCostBasedOnRate(result.remainder,rate)}else{var result=this.factorizeAmountByBaseAmounts(vcAmount,this.prices[this.system],'virtual_currency_int','amount');return result.amount+this.calculateVirtualCurrencyCostBasedOnRate(result.remainder)}}else{return this.calculateVirtualCurrencyCostBasedOnRate(vcAmount)}},calculateVirtualCurrencyAmount:function(realAmount){if(this.customVC.factorizeBasedOnPricePoints){if(this.customVC.factorizeBasedOnPricePoints=='linear_bonus'){var prices=this.prices[this.system];var rate=this.customVC.vcRate;if(this.system=='webmoney'){prices=wmPrices[this.customVC.wmCurrencyCode];rate=this.customVC.wmCurrencyRate}var result=this.factorizeAmountByBaseAmounts(realAmount,prices,'amount','virtual_currency_int',1);if(result.factorizationIndexes.length>0){var basePrice=prices[result.factorizationIndexes[0]];if(basePrice.ap_discount_type=='percentage_bonus'&&basePrice.discount){rate=rate*(1+basePrice.discount/100)}}return result.amount+this.calculateVirtualCurrencyAmountBasedOnRate(result.remainder,rate)}else{var result=this.factorizeAmountByBaseAmounts(realAmount,this.prices[this.system],'amount','virtual_currency_int');return result.amount+this.calculateVirtualCurrencyAmountBasedOnRate(result.remainder)}}else{return this.calculateVirtualCurrencyAmountBasedOnRate(realAmount)}},calculateVirtualCurrencyCostBasedOnRate:function(vcAmount,customRate){var defaultRate=this.customVC.vcRate;if(this.system=='webmoney'){defaultRate=this.customVC.wmCurrencyRate}var rate=customRate||defaultRate;return Math.round(((vcAmount)/rate)*100)/100},calculateVirtualCurrencyAmountBasedOnRate:function(realAmount,customRate){var defaultRate=this.customVC.vcRate;if(this.system=='webmoney'){defaultRate=this.customVC.wmCurrencyRate}var rate=customRate||defaultRate;return Math.round(realAmount*rate)},updateCurrencyCost:function(){var vcAmount=$('custom_flexible_amount').value;if(vcAmount>=this.customVC.minAmount&&vcAmount<=this.customVC.maxAmount){if($('card_but')&&this.isShowPsAfterCheckPrice())$('card_but').show();var text=this.calculateVirtualCurrencyCost(vcAmount);if($(this.customVcAmountPriceInputId)){$(this.customVcAmountPriceInputId).value=this.fomartNumberUsingFormat(text,this.customVC.numberFormatFloat)}if(this.system=='webmoney'){text=text+' '+this.customVC.wmCurrencyCode}else if(this.customVC.priceFormat){text=this.fomartNumberUsingFormat(text,this.customVC.priceFormat)}else{if(this.customVC.currencyCode=='USD'){text='US $'+text}else{text=text+' '+this.customVC.currencyCode}}$(this.customVcAmountPriceViewId).innerHTML=text;if($(this.customVcAmountPriceInputId)){this.hideCustomVcAmountPriceInput()}this.afterUpdateCurrencyCost(vcAmount)}else{if($('card_but')&&this.isShowPsAfterCheckPrice())$('card_but').hide();$(this.customVcAmountPriceViewId).innerHTML='-';if($(this.customVcAmountPriceInputId)){this.hideCustomVcAmountPriceInput()}this.afterUpdateCurrencyCost(0)}},afterUpdateCurrencyCost:function(vcAmount){},checkInput:function(e,additionalAllowedCharCodes){additionalAllowedCharCodes=additionalAllowedCharCodes||[];if((e.charCode<48||e.charCode>57)&&e.charCode!=0&&(additionalAllowedCharCodes&&additionalAllowedCharCodes.indexOf(e.charCode)==-1)){e.preventDefault();this.checkSubmit(e)}},checkSubmit:function(e){if(e.charCode==13){this.selectPrice()}},addAdditionalParam:function(key,value){this.additionalParams[key]=value},addOnSelectPriceListener:function(callback){if(callback&&typeof(callback)==='function'){this.onSelectPriceListeners.push(callback)}},callOnSelectPriceListeners:function(){for(var i=0;i<this.onSelectPriceListeners.length;i++){this.onSelectPriceListeners[i](this)}},appendAdditionalParamsToForm:function(){for(var key in this.additionalParams){if(this.additionalParams.hasOwnProperty(key)){var el=new Element('input',{'type':'hidden',name:key,value:this.additionalParams[key]});$(this.priceFormId).insert(el)}}},appendAdditionalParamsToHash:function(parameters){for(var key in this.additionalParams){if(this.additionalParams.hasOwnProperty(key)){parameters[key]=this.additionalParams[key]}}return parameters},onLoginSuccess:function(ref){ref.loginRequired=false;ref.selectPrice()},setLoginRequired:function(loginRequired){this.loginRequired=loginRequired},getCheckedPrice:function(){var result=null;var ref=this;if(!$(ref.priceId)){return null}var inputs=$(ref.priceId).select('input');inputs.each(function(e){if(e.checked){result=[e]}});return result},calcProgress:function(data,strategy){if(strategy!=data.strategy){return 0}if(!(strategy in this.progressCache)){this.progressCache[strategy]={initial_queue_len:data.queue_len,current_pos:0,inner_pos:0,progress:0}}var cache=this.progressCache[strategy];var pos=cache.current_pos;cache.current_pos=cache.initial_queue_len-data.queue_len;var step_len=100/cache.initial_queue_len;var max_step_val=step_len*cache.current_pos+step_len;if(cache.current_pos!=pos){cache.inner_pos=0}cache.progress=step_len*cache.current_pos+cache.inner_pos;if(cache.progress>max_step_val){cache.progress=max_step_val}cache.progress=parseInt(cache.progress);cache.inner_pos++;return cache.progress},listenForPayment:function(ps,psShortname){var customTimeout=0;if(ps.recentPaymentCheckPsShortname!=psShortname){var oldRecentPaymentCheckPsShortname=ps.recentPaymentCheckPsShortname;ps.recentPaymentCheckPsShortname=psShortname;clearTimeout(ps.recentPaymentCheckTimeout);if(window.PWEyeTracker&&oldRecentPaymentCheckPsShortname!=''){window.PWEyeTracker.trackEvent('recent_payment_check','stop',oldRecentPaymentCheckPsShortname)}}new Ajax.Request(ControllersUrl+'account/get-recent-payment?ps='+psShortname+'&'+UrlParams,{method:'get',onSuccess:function(transport){var success=false;try{var data=transport.responseText.evalJSON();if(data.status){ps.buildConfirmationUi(data.html);success=true;ps.afterRecentPaymentCheckSuccess()}if(ps.isTransactionVerificationFlowActive&&!ps.transactionVerificationFinished&&typeof data['cl_tracked']!='undefined'&&!!data['cl_tracked']){var t_status_active='active';var t_status_resolved='resolved';var q_status_accepted='accepted';var q_status_declined='declined';var q_status_not_approved='not_approved';var q_status_calculating='calculating';var q_strategy_clicks='clicks';var q_strategy_tickets='tickets';var l_accepted=ps._tx('Your transaction is being processed...');var l_blocked=ps._tx('Transaction is under verification');var l_declined=ps._tx('Please <a href="#" class="crm-help-button" data-stage="STAGE_BLOCKED_PS">verify your account</a> to proceed');var l_not_approved=ps._tx('Payment is not completed');var modal={show:function(stage,params){$('crm-root').fire('crm:show',{stage:stage,params:params||{}})},hide:function(){$('crm-root').fire('crm:hide')}};if(!data.action){ps.transactionVerificationFlowUsed=true;if(data.queue_len>0){customTimeout=Math.floor(data.avg_processing_time/(100/data.queue_len));modal.show('blank',{stage:'STAGE_RISK_VERIFICATION',step:1,progress:ps.calcProgress(data,q_strategy_clicks)});ps.show(l_blocked);if(!ps.isTransactionVerificationFlowProgressBarDisplayed){ps.isTransactionVerificationFlowProgressBarDisplayed=true;if(window.PWEyeTracker){window.PWEyeTracker.trackEvent('transaction_verification_flow','show','risk_verification')}}}}else if((data['action']==q_status_accepted)&&(!data['t_exists']||data['t_status']==t_status_resolved)){if(ps.transactionVerificationFlowUsed){modal.show('risk_verification',{progress:100});setTimeout(modal.hide,1000);ps.show(l_accepted);if(window.PWEyeTracker){window.PWEyeTracker.trackEvent('transaction_verification_flow','hide','risk_verification')}ps.transactionVerificationFinished=true;ps.isTransactionVerificationFlowProgressBarDisplayed=false}}else if(data['action']==q_status_declined){if(!data['t_status']&&!data['t_exists']){modal.show('risk_upload',data);success=true;if(window.PWEyeTracker){window.PWEyeTracker.trackEvent('recent_payment_check','stop',psShortname);window.PWEyeTracker.trackEvent('transaction_verification_flow','show','risk_upload')}document.observe('crm:inquiry-added',function(){document.stopObserving('crm:inquiry-added');ps.listenForPayment(ps,psShortname);if(window.PWEyeTracker){window.PWEyeTracker.trackEvent('recent_payment_check','start',psShortname)}});ps.isTransactionVerificationFlowProgressBarDisplayed=false}else if(data['t_status']==t_status_resolved){modal.show('risk_declined',data);ps.show(l_declined);window.PWEyeTracker.trackEvent('transaction_verification_flow','show','risk_declined');ps.transactionVerificationFinished=true;ps.isTransactionVerificationFlowProgressBarDisplayed=false}else if(data['t_status']==t_status_active){modal.show('blank',{stage:'STAGE_RISK_VERIFICATION',step:2,progress:ps.calcProgress(data,q_strategy_tickets)});ps.show(l_blocked);if(!ps.isTransactionVerificationFlowProgressBarDisplayed){ps.isTransactionVerificationFlowProgressBarDisplayed=true;if(window.PWEyeTracker){window.PWEyeTracker.trackEvent('transaction_verification_flow','show','risk_verification')}}}}else if(data['action']==q_status_not_approved){modal.show('blank',{stage:'STAGE_RISK_NOT_APPROVED'});ps.show(l_not_approved);if(window.PWEyeTracker){window.PWEyeTracker.trackEvent('transaction_verification_flow','show','risk_not_approved')}ps.transactionVerificationFinished=true;ps.isTransactionVerificationFlowProgressBarDisplayed=false}else if(data['action']==q_status_calculating){}}}catch(exception){}if(!success){ps.recentPaymentCheckTimeout=setTimeout(ps.listenForPayment.curry(ps,psShortname),customTimeout>2000?customTimeout:2000)}},onFailure:function(){ps.recentPaymentCheckTimeout=setTimeout(ps.listenForPayment.curry(ps,psShortname),customTimeout>2000?(customTimeout*2):4000)}})},afterRecentPaymentCheckSuccess:function(){},buildConfirmationUi:function(html){if($('ps_payment_cnt')){$('ps_payment_cnt').update('<div class="thankyou_widget">'+html+'</div>')}if($('pay_methods_container')){$('pay_methods_container').hide()}if($('ps_back_button')){$('ps_back_button').hide()}if($('ps_step_1')){$('ps_step_1').hide()}if($('ps_step_2')){$('ps_step_2').hide()}if($('ps_step_3')){$('ps_step_3').hide()}this.hidePriceMessage()},isPriceDefault:function(price,index){if(this.useLastPriceAsDefaultOnSelectingPs){if(typeof this.lastPriceIndex=='undefined'){return price['default']}return index==this.lastPriceIndex}else if(price['default']){this.priceDefault=price;return true}return false},findPriceIndex:function(id,prices){for(p in prices){p=parseInt(p);if(Math.floor(p)==p&&prices[p]['id']==id){return p}}return 0},trackGoogleAnalyticsEvent:function(event,params){if(this.opt.trackGoogleAnalyticsEvents&&this.opt.trackGoogleAnalyticsEvents.indexOf(event)>=0){params=params||this.getParamsForGoogleAnalyticsEvent(event);$(document.body).insert({bottom:'<iframe width="1" height="1" style="border:none" src="'+(BaseUrlThirdparty?BaseUrlThirdparty:BaseUrl)+'api/google-analytics/?skey='+skey+'&event='+event+'&params='+encodeURIComponent(Object.toJSON(params))+'"></iframe>'})}},validateForm:function(){if($('widget_email_field')){$('widget_email_field').removeClassName('is-error');var re=/^(([^<>()\[\]\.,;:\s@\"]+(\.[^<>()\[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i;if(!re.test($('widget_email_field_input').value)){$('widget_email_field').addClassName('is-error');return false}}return true}});var PaymentSystemsSelect=Class.create(PaymentSystems,{footnotes:['*','','',''],getRecurringBillingPlansMark:function(){return'^'},listenRows:function(){var ref=this;if(this.showPsAfterCheckPrice){$(this.priceId).observe('change',function(){ref.afterCheckPrice(this.value)})}},getPrice:function(){return $F(this.priceId)},updatePricePoints:function(system){var html='';if(system=='smscoin'&&this.smsOperators){this.show(smsCoinPw.getHtmlForPaymentWall());smsCoinPw.listenOperatorSelect()}else{if(this.paymentSystems[system]['new_window']==1){html='<form action="" target="_blank" id="ps_price_form" method="post">';if(this.flexibleAmount){html+='<input type="hidden" name="amount" id="flexible_amount" value="0" />';html+='<input type="hidden" name="currencyCode" id="flexible_currency" value="" />'}}html+=this.wrapPricePoints(this.wrapPricePointsSelect(this.buildPricePoints(system),system),system);html+=this.buildButton(system);html+='<b class="clearb"></b>';if(this.paymentSystems[system]['new_window']==1){html+='</form>'}if(system=='cherrycredits'){html+='<p class="small" style="text-align:left;">*CC = Cherry Credits</p>'}if(system=='coinbasebitcoin'){html+='<p style="text-align:left;"><a href="https://bitcoin.org/en/" target="_blank"><i>'+this._tx('What is Bitcoin?')+'</i></a></p>'}if(system=='epinpaymentsystem'){html+='<p style="text-align:left;"><a href="http://paymentwall.com/distribution" target="_blank"><i>'+this._tx("Don\'t have Mint yet? Click here to buy!")+'</i></a></p>'}if(system=='eprepagcard'){html+='<p style="text-align:left;"><a href="http://www.e-prepag.com.br/busca-pdv.php" target="_blank"><i>'+this._tx("Don't have a pin? Find a sales outlet!")+'</i></a></p>'}this.show(html);this.afterUpdatePricePoints(system)}},getPricesSelectClass:function(){return'floatl'},buildPricePoints:function(system){var html='<select name="p" id="ps_price" class="'+this.getPricesSelectClass()+'">';var price,p;var trialCounter=0;for(p in this.prices[system]){p=parseInt(p);if(Math.floor(p)==p){price=this.prices[system][p];if(price['hide']){continue}var priceDefault=this.isPriceDefault(price,p);html+='<option value="'+price['id']+'"'+(priceDefault?' selected':'')+' id="price_'+(price['prefix']?price['prefix']:'')+price['id']+'">';if(this.recurringSystems[system]&&this.recurringSystems[system].recurring_price_present&&this.recurringSystems[system].onetime_price_present&&price.recurring){html+=this.getRecurringBillingPlansMark()}if(price['trial']){trialCounter++;html+=this.buildTrialCounter(trialCounter)}html+=price['virtual_currency']+'&nbsp;'+this._tx('#c for #amount_formatted').replace('#amount_formatted','').replace('#c',price['currency_name']?price['currency_name']:this.currency);html+=price['price'];if(price['comment']){html+=' &ndash; '+price['comment']}if(price['promo']){html+=' &ndash; '+price['promo']}html+='</option>'}}html+='</select>';return html},buildButton:function(system){var html='';html+='<div id="card_but" class="button">';if(system!='googlecheckout'){var buttonTitle=this.titles.buyButton?this._tx(this.titles.buyButton).replace('%s',this.currency):(this._tx('Buy')+' '+this.currency);html+='<a class="button but3 left" href="#" id="ps_psb">'+buttonTitle+'</a>'}else{html+='<a href="#" id="ps_psb" style="margin-left:5px;"><img src="'+BaseUrl+'images/googlecheckout_button.png"></a>'}html+='</div>';return html},buildTrialCounter:function(trialCounter){return this.getFootnote(trialCounter-1)},getFootnote:function(index){if(!this.footnotes[index]){var footnote='*';for(var i=0;i<=index-this.footnotes.length;i++){footnote+='*'}return footnote}return this.footnotes[index]}});var PaymentSystemsSelectSlim=Class.create(PaymentSystemsSelect,{updateTitle:function(system){},showPriceMessage:function(){},hidePriceMessage:function(){},buildButton:function(system){var html='';if(system!='googlecheckout'){html+='<a class="but" href="#" id="ps_psb">'+this._tx('Buy')+'</a>'}else{html+='<a href="#" id="ps_psb" style="margin-left:5px;float:left;"><img src="'+BaseUrl+'images/googlecheckout_button.png"></a>'}return html},updatePricePoints:function(system){var html='';if(system=='smscoin'){return}else{html='<form action="" target="paymentwallPopup" id="ps_price_form" method="post">';if(this.flexibleAmount){html+='<input type="hidden" name="amount" id="flexible_amount" value="0" />';html+='<input type="hidden" name="currencyCode" id="flexible_currency" value="" />'}html+=this.buildPricePoints(system);html+=this.buildButton(system);html+='</form>';this.show(html)}},removeCouponDiscountOnChange:function(){},selectPrice:function(e){if(e){Event.stop(e)}var p=this.getPrice();if(this.loginRequired&&this.loginFormDefined()){loginForm.addOnLoginListeners(this.onLoginSuccess,this);loginForm.openSignupFormQuick('signupQuick');return}if(this.useWindowPopup()){var paymentwallPopup=this.openPaymentwallPopup('paymentwallPopup');paymentwallPopup.focus()}if(p!=''){if($(this.priceFormId)){this.callOnSelectPriceListeners();if(this.flexibleAmount){var priceData=this.getPriceData(p);if(priceData&&priceData['flexible']&&$(this.flexibleAmountContainer)){$(this.flexibleAmountContainer).setValue(priceData['amount']);$(this.flexibleCurrencyContainer).setValue(priceData['cu_code'])}}this.appendAdditionalParamsToForm();$(this.priceFormId).action=this.getController(p);if(this.useWindowPopup()){this.submitPriceForm()}else{this.showPsWidgetInIframe()}}}this.trackGoogleAnalyticsEvent('price_selected')},useWindowPopup:function(){return true}});var PaymentSystemsSelectSlimCombo=Class.create(PaymentSystemsSelectSlim,{getPricesSelectClass:function(){return'prices'},buildButton:function(system){var html='';if(system!='googlecheckout'){html+='<a class="but buy" href="#" id="ps_psb"><b>'+this._tx('Buy')+'</b></a>'}else{html+='<a href="#" id="ps_psb" style="margin-left:5px;float:left;"><img src="'+BaseUrl+'images/googlecheckout_button.png"></a>'}return html}});var PaymentSystems2Click=Class.create(PaymentSystemsSelectSlim,{listenRows:function(){if(this.showPsInSameWindow){this.cardHolderId='iframe_preloader';this.selectCardId='select_card'}},getAutoVisible:function(){return Math.floor($(this.container).getWidth()/111)*Math.floor($(this.container).getHeight()/45)},updatePricePoints:function(system){this.showPricePoints(this.buildPricePoints(system));this.showButton(this.buildButton(system));if(this.couponsFieldAvailable){if(!this.isMobileSystem(system)){$('coupons_box').update(this.buildCouponField());this.observeCouponClick()}else{$('coupons_box').update('')}this.removeCouponDiscountOnChange()}if($(this.recurringMessageContainer)){var html='';if(this.paymentSystems[system]['protect_customers_law']){html+='<div>&deg; '+this._tx(this.titles.protectCustomersLaw?this.titles.protectCustomersLaw:'Your credit card will be charged in USD, the final price may vary.')+'</div>'}if(this.recurringSystems[system]&&this.recurringSystems[system].recurring_price_present){html+='<div>'+this._buildRecurringMessage(system)+'</div>'}$(this.recurringMessageContainer).update(html)}},showPricePoints:function(c){$('ps_price_cnt2').update(c)},showButton:function(c){$('ps_psb_cnt').update(c)},buildCouponField:function(){var html='';if(this.couponLastError){html+='<span type="text" class="rounded_msg action p4">No more attempts left to provide the valid code. Please, try again later.</span>';html+='<a href="javascript:void(0);" class="rounded_button p4 disabled" id="coupon_code_submit">Try later</a>'}else{html+='<input type="text" class="rounded_input p4" placeholder="I have my coupon" id="coupon_code">';html+='<a href="javascript:void(0);" class="rounded_button p4" id="coupon_code_submit">Apply</a>'}return html},observeCouponClick:function(){if(this.couponsFieldAvailable&&!this.isMobileSystem()){if(!this.couponLastError&&!!$('coupon_code_submit')){$('coupon_code_submit').observe('click',this.checkCouponAjax.bind(this,this.getCurrentPriceId()));var ref=this;$('ps_price').observe('change',function(){ref.checkCouponEdit()});this.applyCoupon()}this.couponChecked=false}return false},afterCheckCouponSuccess:function(priceId,price){$('coupon_code_submit').update('Clear');$('coupon_code_submit').stopObserving('click');$('coupon_code_submit').observe('click',this.checkCouponEdit.bind(this));this.couponChecked=true;var html='';html+='<td colspan="3"><span class="coupon_final left">Coupon Discount: '+price.discount+'</span>';html+='<span class="coupon_final right">Final Price: '+price.discounted_price_amount+'</span></td>';$('coupon_result').update(html)},afterCheckCouponFailed:function(response){var ref=this;var html='';html+='<span class="rounded_msg action p4">'+response.message+'</span>';if(response.error!=6){html+='<a href="javascript:void(0);" class="rounded_button p4" id="coupon_code_submit">Try again</a>'}else{html+='<a href="javascript:void(0);" class="rounded_button disabled p4" id="coupon_code_submit">Try later</a>'}$('coupons_box').update(html);$('coupon_code_submit').stopObserving('click');this.couponError=true;if(response.error!=6){$('coupon_code_submit').observe('click',function(){$('coupon_code_submit').stopObserving('click');$('coupons_box').update(ref.buildCouponField());$('coupon_code_submit').observe('click',ref.checkCouponAjax.bind(ref,ref.getCurrentPriceId()))})}else{this.couponLastError=true}},checkCouponEdit:function(){if(!this.couponError){this.clearCoupon()}else if(!this.couponLastError){$('coupon_code_submit').stopObserving('click');$('coupons_box').update(this.buildCouponField());$('coupon_code_submit').observe('click',this.checkCouponAjax.bind(this,this.getCurrentPriceId()))}this.removeCouponDiscountOnChange()},removeCouponDiscountOnChange:function(){if(this.couponsFieldAvailable){var html='';$('coupon_result').update(html)}},getCurrentPriceId:function(){var prefix=this.getPriceData(this.getPrice()).prefix?this.getPriceData(this.getPrice()).prefix:'';return $('price_'+prefix+this.getPrice()).value},useWindowPopup:function(){return!((this.system=='cc'||this.system=='cceuro')&&this.showPsInSameWindow)},getPsParameters:function(){return $(this.priceFormId)?$(this.priceFormId).serialize(true):{}},getAjaxMethod:function(){return'POST'},isHidePreloaderOnPsWidgetLoad:function(){return true},getIframeList:function(){return $(this.cardHolderId).select('iframe')},showContent:function(html){var reg=/class="iframecc" id="iframecc"/i;if(!reg.test(html)){$(this.backButtonId).hide();this.submitPriceForm()}else{$(this.selectCardId).hide();if($('ps_widget_preloader'))$('ps_widget_preloader').show();if($(this.cardHolderId)){$(this.cardHolderId).update(html);$(this.cardHolderId).show()}else{var container=$(this.backButtonId)?$(this.backButtonId):$(this.selectCardId);container.insert({after:"<div id = '"+this.cardHolderId+"'>"+html+"</div>"})}}},showBackButton:function(){if(!$(this.backButtonId)){var a=new Element('a',{href:'#',id:this.backButtonId,'class':'back'}).update('&laquo; '+this._tx('Back to all payment methods'));$(this.selectCardId).insert({after:a});this.listenBackButton()}else{$(this.backButtonId).show()}},listenBackButton:function(){var ref=this;if($(this.backButtonId)){$(this.backButtonId).stopObserving('click');$(this.backButtonId).observe('click',function(e){e.stop();if($(ref.cardHolderId))$(ref.cardHolderId).hide();if($(ref.selectCardId))$(ref.selectCardId).show();$(ref.backButtonId).hide()})}}});var PaymentSystems2ClickFlexible=Class.create(PaymentSystems2Click,{afterOpen:function(event){if(event){this.selectPrice();this.applyCoupon()}}});var PaymentSystemsMobilePayPlus=Class.create(PaymentSystems,{show:function(content){$(this.contentId).toggle();$('ps_widget').update(content);$('ps_widget_main').toggle()},mobileCurrencyTog:function(){if($('flag_select_link').hasClassName('flag_holder title_but_active')){this.mobileLangTog()}$('cur').toggle();$('overlay').toggle();if($('currency_link_open')){$('currency_link_open').toggleClassName('currency title_but_active','currency')}},mobileLangTog:function(){if($('currency_link_open')&&$('currency_link_open').hasClassName('currency title_but_active')){this.mobileCurrencyTog()}$('lang_main_div').toggle();$('lang').toggle();$('overlay').toggle();$('flag_select_link').toggleClassName('flag_holder title_but_active','flag_holder')},addMobileEventListeners:function(){var ref=this;$('go_to_prices').observe('click',ref.mobileGoToPrices.bindAsEventListener(ref));if($('currency_link_open')){$('currency_link_open').observe('click',ref.mobileCurrencyTog.bindAsEventListener(ref));$('currency_link_close').observe('click',ref.mobileCurrencyTog.bindAsEventListener(ref))}$('flag_select_link').observe('click',ref.mobileLangTog.bindAsEventListener(ref));$('lang_close_link').observe('click',ref.mobileLangTog.bindAsEventListener(ref));$('custmer_service_button').observe('click',ref.customerServicePaymentsShow.bindAsEventListener(ref));$('term_of_service_link').observe('click',ref.termOfSsrviceShow.bindAsEventListener(ref));$('privacy_policy_link').observe('click',ref.privacyPolicyShow.bindAsEventListener(ref))},customerServicePaymentsShow:function(){this.customerServiceTabShow('payments')},getPriceData:function(priceId){var psPrice=this.getPricePaymentSystem();for(var i in this.prices[psPrice]){if(priceId==this.prices[psPrice][i]['id']){return this.prices[psPrice][i]}}return false},termOfSsrviceShow:function(){this.customerServiceTabShow('terms')},privacyPolicyShow:function(){this.customerServiceTabShow('privacy-policy')},customerServiceTabShow:function(tab){if($('ps_widget').className!='crm'){$('ps_widget').className='crm'}$(this.contentId).setStyle({display:'none'});$('ps_widget_main').setStyle({display:'block'});$('ps_widget').update('<iframe width="620" height="590" frameborder="0" allowtransparency="true" style="margin: 0px; padding: 0px; border: 0;" src="'+ControllersUrl+'account/'+tab+'/?'+UrlParams+'"></iframe>')},mobileGoToPrices:function(){$(this.contentId).toggle();$('ps_widget').className='data2';$('ps_widget_main').toggle()},selectPrice:function(e){if(e){if(this.appendPaymentForm&&!$(this.priceFormId)){e.target.stopObserving()}Event.stop(e)}if(this.getPrice()!=''){this.callOnSelectPriceListeners();if(this.showPsInNewWindow||this.paymentSystems[this.getPricePaymentSystem()]['new_window']==1){if(this.nonIframePsInPopup){this.openPaymentwallPopup('paymentwallPopup')}else{this.showPsWidgetInNewWindow()}}else{this.showPsWidgetInIframe()}}},getPricePaymentSystem:function(){return this.getCheckedPrice()[0].readAttribute("data-price-controller")},getController:function(p){var priceData=this.getPriceData(p);var extraParams="";if(priceData){if(priceData['ag_type']){extraParams+='&good='+priceData['ag_type']}if(priceData['flow']){extraParams+='&flow='+priceData['flow']}}if(this.couponsFieldAvailable&&$('coupon_code')&&!this.isMobileSystem()){extraParams+='&coupon='+$('coupon_code').value}return ControllersUrl+this.getPricePaymentSystem()+'/'+this.clickAction+'?'+UrlParams+extraParams},showPsWidgetInNewWindow:function(target){this.showPriceMessage();var dimensions=this.getWidgetCustomDimensions();window.open(this.getController(this.getPrice())+'&p='+this.getCurrentPriceId(),'paymentwallPopup','scrollbars=yes,resizable=yes,location='+this.getWidgetCustomLocation()+',width='+dimensions[0]+',height='+dimensions[1])}});var PaymentSystemsWithDrm=Class.create(PaymentSystems,{buildConfirmationUi:function(response){var html='<div id="step-3" style="width: 780px;margin: 0 auto;">';html+='<h2 style="margin: 40px 0px 16px 0px;text-align: center;font-size: 26px;font-weight: 600;color: #8bc964;">'+this._tx('Thank you for your purchase!')+'</h2>';html+='<p style="margin: 0px 0px 70px 0px;text-align: center;">'+this._tx('Enjoy your Mint ePIN! Now you can use<br/>this code to finish your checkout process.')+'</p>';html+='<form><input type="text" style="height: 30px;padding: 4px 8px;border: 1px solid #8bc964;border-radius: 3px;font-size: 16px;color: #8bc964;width: 158px;margin: 0px 0px 0px 308px;" readonly="readonly" value="'+response[0].drm_key+'">';html+='</form>';html+='</div>';this.showKeys(html);this.trackGoogleAnalyticsEvent('payment_success')},initRecentPaymentCheck:function(){if(hasDrm&&this.activeRecentPaymentChecks.indexOf('drm')==-1){var currentSystem=this.system;this.listenForPayment(this,currentSystem);this.activeRecentPaymentChecks.push('drm')}},listenForPayment:function(ps){if(!ps.keysShown){new Ajax.Request(ControllersUrl+'paymentpingback/get-ws-key?skey='+skey,{method:'get',onSuccess:function(transport){try{if(transport.responseText!='false'){ps.keysShown=true;ps.buildConfirmationUi(transport.responseText.evalJSON())}}catch(exception){}if(!ps.keysShown){setTimeout(ps.listenForPayment.curry(ps),2000)}},onFailure:function(){setTimeout(ps.listenForPayment.curry(ps),4000)}})}}});var PaymentSystemsCart=Class.create(PaymentSystems,{buildPricePoints:function(system){var cartFeesEnabled=this.customCommission&&this.showCartFees;html="";if(unavalilableProducts){html+='<div class="product_description">'+this._tx('One of the selected products is currently unavailable')+'</div>';html+='<b class="clearb"></b><br/>'}html+='<div class="cart"><table cellspacing="0" cellpadding="0">';html+='<tr><th>'+this._tx('Product')+'</th><th>'+this._tx('Description')+'</th><th align="center">'+this._tx('Quantity')+'</th><th>'+this._tx('Price')+'</th>'+(cartFeesEnabled?('<th>'+this._tx('Fees')+'</th>'):'')+'<th>'+this._tx('Total Price')+'</th></tr>';for(good in cartProducts){var goodItem=cartProducts[good];html+='<tr><td>'+goodItem['ag_name']+'</td><td>'+goodItem['ag_description']+'</td><td align="center">'+goodItem['quantity']+'</td><td>'+goodItem['p_amount_formatted']+'</td>'+(cartFeesEnabled?('<td>'+goodItem[system]['p_amount_fees']+'</td>'):'')+(cartFeesEnabled?('<td>'+goodItem[system]['p_amount_formatted_total']+'</td>'):('<td>'+goodItem['p_amount_formatted_total']+'</td>'))+'</tr>'}var p=this.prices[system][0];html+='<tr><td class="total" colspan="'+(cartFeesEnabled?'5':'4')+'">'+this._tx('Total')+':</td><td id="cart_price_total">'+p['price']+'</td></tr>';html+='</table></div>';if(this.couponsFieldAvailable&&!this.isMobileSystem(system)){html+=this.buildCouponField()}return html},getPriceValue:function(){return this.prices[this.system][0].p_id},getPriceData:function(priceId){for(var i in this.prices[this.system]){if(priceId==this.prices[this.system][i]['p_id']){return this.prices[this.system][i]}}return false},observeCouponClick:function(){if(this.couponsFieldAvailable&&!this.isMobileSystem()){if($('coupon_code_submit')){if(!this.couponLastError){$('coupon_code_submit').removeClassName('disabled');$('coupon_code_submit').observe('click',this.checkCouponAjax.bind(this,this.getPriceValue()));this.applyCoupon()}else{$('coupon_code_submit').addClassName('disabled')}}this.couponChecked=false}return false},afterCheckCouponSuccess:function(priceId,price){$('coupon_code_submit').update('Clear');$('coupon_code_submit').stopObserving('click');$('coupon_code_submit').observe('click',this.checkCouponEdit.bind(this,priceId));this.couponChecked=true;var html='';html+='<span class="removed">'+this.getPriceData(priceId).price+'</span></br>';html+='<span class="coupon_final cart">'+price.discounted_price_amount+'</span>';$('cart_price_total').update(html);if((this.showPsAfterSelectingPsOnlyInSameWindow&&!this.paymentSystems[this.system].new_window)||this.showPsAfterSelectingPs){this.selectPrice()}},afterCheckCouponFailed:function(response){var ref=this;var html='';html+='<span class="rounded_msg action">'+response.message+'</span>';if(response.error!=6){html+='<a href="javascript:void(0);" class="rounded_button " id="coupon_code_submit">Try again</a>'}else{html+='<a href="javascript:void(0);" class="rounded_button disabled" id="coupon_code_submit">Try later</a>'}$('coupon_code_div').update(html);$('coupon_code_submit').stopObserving('click');this.couponError=true;if(response.error!=6){$('coupon_code_submit').observe('click',function(){$('coupon_code_submit').stopObserving('click');$('coupon_code_div').update(ref.updateCouponField());$('coupon_code_submit').observe('click',ref.checkCouponAjax.bind(ref,ref.getPriceValue()))})}else{this.couponLastError=true}},checkCouponEdit:function(priceId){this.clearCoupon();$('cart_price_total').update(this.getPriceData(priceId).price);if((this.showPsAfterSelectingPsOnlyInSameWindow&&!this.paymentSystems[this.system].new_window)||this.showPsAfterSelectingPs){this.selectPrice()}},listenRows:function(system){},updatePricePoints:function(system){var html='';if(system=='smscoin'&&this.smsOperators&&this.priceView!='mobile'){this.show(smsCoinPw.getHtmlForPaymentWall());smsCoinPw.listenOperatorSelect()}else{html+=this.wrapPricePoints(this.buildPricePoints(system),system);if(this.pricesView!='mobile'){html+='<div id="card_but" class="button">';if(system!='googlecheckout'){var buttonTitle=this.titles.buyButton?this._tx(this.titles.buyButton).replace('%s',this.currency):(this._tx('Buy #c')=='Buy #c'?this._tx('Buy')+' '+this.currency:this._tx('Buy #c').replace('#c',this.currency));html+='<a class="button but2 left" href="#" id="ps_psb">'+buttonTitle+'</a>'}else{html+='<a class="floatl" href="#" id="ps_psb" style="width:180px;"><img src="'+BaseUrl+'images/googlecheckout_button.png"></a>'}if((this.paymentSystems[system]['new_window']==1||this.showPsInNewWindow)&&!this.showPsInSameWindow){html+='<b class="clearb"></b><p class="small">'+this._tx('Opens new window')+'</p>'}if(system=='paypal'&&this.showPaypalButtonBranding){html+='<table class="branding"><tr>';html+='<td><a class="logo" target="_blank" href="http://paymentwall.com">Paymentwall Inc.</a></td>';html+='<td><span>'+this.paypalButtonBrandingNotice+'</span></td>';html+='</tr></table>'}html+='<b class="clearb"></b></div>'}if(system=='cherrycredits'){html+='<p class="small" style="text-align:left;">*CC = Cherry Credits</p>'}if(system=='coinbasebitcoin'){html+='<p style="text-align:left;"><a href="https://bitcoin.org/en/" target="_blank"><i>'+this._tx('What is Bitcoin?')+'</i></a></p>'}if(system=='epinpaymentsystem'){html+='<p style="text-align:left;"><a href="http://paymentwall.com/distribution" target="_blank"><i>'+this._tx("Don\'t have Mint yet? Click here to buy!")+'</i></a></p>'}if(system=='paypal'&&this.showPaypalEcheckNotice){var echeckPhrase='When using eCheck, it usually takes between #numberFrom and #numberTo business days for it to clear and you to '+(this.useSubscriptions?'upgrade':'get the')+' #c.';html+='<p class="small" style="text-align:left;">'+this._tx(echeckPhrase).replace('#c',this.currency).replace('#numberFrom',3).replace('#numberTo',8)+'</p>'}if(system=='eprepagcard'){html+='<p style="text-align:left;"><a href="http://www.e-prepag.com.br/busca-pdv.php" target="_blank"><i>'+this._tx("Don't have a pin? Find a sales outlet!")+'</i></a></p>'}if(this.recurringSystems[system]&&this.recurringSystems[system].recurring_price_present){html+=this.buildRecurringMessage(system)}html+='<b class="clearb"></b>';this.show(html)}this.afterUpdatePricePoints(this.system);this.observeCouponClick();this.listenRows()},selectPrice:function(e){if(e){if(this.appendPaymentForm&&!$(this.priceFormId)){e.target.stopObserving()}Event.stop(e)}if(hasDrm){this.initRecentPaymentCheck()}if(this.paymentSystems[this.system].new_window==true){this.showPsWidgetInNewWindow()}else{this.showPsWidgetInIframe()}},initRecentPaymentCheck:function(){if(hasDrm&&this.activeRecentPaymentChecks.indexOf('drm')==-1){var currentSystem=this.system;this.listenForPayment(this,currentSystem);this.activeRecentPaymentChecks.push('drm')}},getPrice:function(){var ref=this;return this.system},listenForPayment:function(ps){if(!ps.keysShown){new Ajax.Request(ControllersUrl+'paymentpingback/get-ws-key?skey='+skey,{method:'get',onSuccess:function(transport){try{if(transport.responseText!='false'){ps.keysShown=true;ps.buildConfirmationUi(transport.responseText.evalJSON())}}catch(exception){}if(!ps.keysShown){setTimeout(ps.listenForPayment.curry(ps),2000)}},onFailure:function(){setTimeout(ps.listenForPayment.curry(ps),4000)}})}},buildConfirmationUi:function(response){var html='<div style="position:relative;" id="paymentwall2"><div class="bg"><h1>'+this._tx('Thank you for purchase!')+'</h1>';for(var app in response){app=parseInt(app);if(Math.floor(app)==app){html+='<div class="cart_section">';html+='<div class="product_description"><strong>'+response[app]['ag_name']+'</strong><br />';html+=(response[app]['drm_key']?this._tx('License Key')+': <b>'+response[app]['drm_key']+'</b>':'');html+='&nbsp;';html+=(response[app]['ag_download_link']?'</div><a class="button" target="_blank" href="'+response[app]['ag_download_link']+'">'+this._tx('Download')+'</a>':'</div>');html+='<div class="clearb"></div>'}}html+='</div>';this.showKeys(html);this.trackGoogleAnalyticsEvent('payment_success')},showKeys:function(content){$('paymentwall2').update(content);if($('ps_step_1')){$('ps_step_1').hide()}if($('ps_step_2')){$('ps_step_2').hide()}if($('ps_step_3')){$('ps_step_3').hide()}}});PaymentSystemsWithDrm.prototype.showKeys=PaymentSystemsCart.prototype.showKeys;var PaymentSystemsHorizontalPricepoints=Class.create(PaymentSystems,{buildPricePoints:function(system){var html='<ul id="ps_price" class="clearfix choose-package">';var price,p;var counter=1;var pricePointsNumber=this.pricePointsNumber||0;var priceDefault=false;for(p in this.prices[system]){p=parseInt(p);if((!pricePointsNumber||counter<=pricePointsNumber)&&Math.floor(p)==p){price=this.prices[system][p];var priceDefault=this.isPriceDefault(price,p);html+='<li class="package'+(price['tag']?' tag_'+price['tag']:'')+(priceDefault?' selected':'')+'">';html+='<input type="radio" style="display: none" value="'+price['id']+'" name="p"'+(priceDefault?' checked':'')+' id="price_'+price['id']+'" />';html+='<div href="#" rel="price" id="price_'+price['id']+'_" class="price_button'+(priceDefault?' pricepoint_over':'')+(price['product_id']?' product_'+price['product_id']:'')+'">';html+=this.buildPricePointContent(price,counter);html+='</div>';html+='</li>';counter++}}if(this.isCustomVcInputAvailable(system)){html+='<li class="package package_custom_flexible">';html+='<input type="radio" name="p" value="custom_flexible" id="price_flexible_custom" style="display: none">';html+='<div href="#" rel="price" id="price_flexible_custom_" class="price_button">';html+=this.buildPricePointContent([],counter,true,system);html+='</div>';html+='</li>'}html+='</ul>';return html},afterInitialize:function(){this.showPreloaderOnPsLoadInSameWindow=true;this.reload()},getRowSelectorForListenRows:function(){return'div[rel="price"]'},afterChangeStep:function(){if(this.showSelectedProduct){var price=this.prices[this.system][this.findPriceIndex(this.getPrice(),this.prices[this.system])];var html=this.buildSelectedProductContent(price);if($('selected_product')){$('selected_product').update(html)}else{$('ppage').insert('<div id="selected_product">'+html+'</div>')}if(price['product_id']){$('selected_product').className='product_'+price['product_id']}$('selected_product').show()}},buildSelectedProductContent:function(price){return'<div class="price_button">'+this.buildPricePointContent(price)+'</div>'},buildPricePointContent:function(price,counter,customFlexiblePrice,system){var html='';counter=counter||0;customFlexiblePrice=customFlexiblePrice||false;system=system||'';if(price['discounted_price']){html+='<div class="discounted_price">'+price['discounted_price']+'</div>'}if(customFlexiblePrice){html+='<div class="price" id="'+this.customVcAmountPriceViewId+'"'+(this.customVC.realCurrencyInput?' style="display:none"':'')+'>-</div>';if(this.customVC.realCurrencyInput){html+='<div id="'+this.customVcAmountPriceInputContainerId+'" class="price price_customvc">';var priceInputHtml='<input type="text" name="" id="'+this.customVcAmountPriceInputId+'" autocomplete="off" class="other_amount" placeholder="...">';if(system=='webmoney'){html+=priceInputHtml+' '+this.customVC.wmCurrencyCode}else if(this.customVC.priceFormatInteger){html+=this.customVC.priceFormatInteger.replace('%integer%',priceInputHtml)}else{html+=priceInputHtml+' '+this.customVC.currencyCode}html+='</div>'}}else{html+='<div class="price">'+this.wrapPricePoint(price)+'</div>'}if(this.titles.productCustomMessage){var customMessage=this._tx(this.titles.productCustomMessage);var customMessageParts=customMessage.match(/#[a-z_]*/g);customMessageParts.each(function(item){var index=item.replace('#','');customMessage=customMessage.replace('#'+index,price[index])});html+='<div class="product_custom_message">'+this._tx(customMessage)+'</div>'}if(this.displaySubscriptionMonthlyPrices){if(price['discounted_price_single']!=price['price_single']){html+='<div class="discounted_price_single">'+price['discounted_price_single']+(price['period_type']==''?'':' / ')+price['period_type']+'</div>'}html+='<div class="price_single">'+price['price_single']+(price['period_type']==''?'':' / ')+price['period_type']+'</div>'}html+='<div class="vc">';html+='<div class="vc_in">';html+='<strong>';if(customFlexiblePrice){html+='<input type="text" name="" id="custom_flexible_amount" autocomplete="off" class="other_amount" placeholder="...">'}else{html+=price['virtual_currency']}html+='</strong>';var currencyName=price['currency_name']?price['currency_name']:this.currency;if(price['trial']){trialCounter++;currencyName+=this.buildTrialCounter(trialCounter)}html+='<br /><span class="vc_name">'+currencyName+'</span>';html+='</div>';html+='</div>';html+='<div class="coins c'+counter+'"></div>';if(price['comment']){html+='<div class="discount">';html+=price['comment'];html+='</div>'}if(price['promo']){html+='<div class="bonus">';html+='<div class="bonus_in">';html+=price['promo'];html+='</div>';html+='</div>'}if(price['tag']=='best'){html+='<div class="tag2 value '+Language+'"><div>'+this._tx('Best Value')+'</div></div>'}else if(price['tag']=='popular'){html+='<div class="tag2 popular '+Language+'"><div>'+this._tx('Most Popular')+'</div></div>'}return html},afterUpdateCurrencyCost:function(vcAmount){var bonuses=false;if(this.customVC.bonusVcCummulativeBases){bonuses=this.customVC.bonusVcCummulativeBases||{}}else if(this.customVC.bonusVcCummulativeBasesPerCurrency){for(var prop in this.prices[this.system]){var firstItem=this.prices[this.system][prop];break}bonuses=this.customVC.bonusVcCummulativeBasesPerCurrency[firstItem.cu_code]||this.customVC.bonusVcCummulativeBasesPerCurrency['all']||{}}var bonusVcFormat=this.customVC.bonusVcFormat||'#c';var bonusVcAmountText='';if(bonuses){var vcAmountRemainder=parseInt(vcAmount);var bonusVcAmount=0;var counter=0;var bonusKeys=[];$H(bonuses).each(function(pair){bonusKeys.push(parseInt(pair.key))});bonusKeys=bonusKeys.sort(function(a,b){return b-a});var minBonus=bonusKeys.min();while(vcAmountRemainder>=minBonus){$H(bonusKeys).each(function(pair){var key=pair.value;while(vcAmountRemainder>=key){vcAmountRemainder-=key;bonusVcAmount+=bonuses[key];if(counter++>100)return}})}var bonusThousands=(Math.floor(bonusVcAmount/1000));var bonusRest=bonusVcAmount-bonusThousands*1000;bonusVcAmountText=(bonusThousands>0?bonusThousands+',':'')+(bonusRest==0?'000':bonusRest);if(!$('custom_flexible_amount_bonus')){$('price_flexible_custom_').insert({bottom:'<div class="bonus"><div class="bonus_in" id="custom_flexible_amount_bonus"></div></div>'})}$('custom_flexible_amount_bonus').update(bonusVcAmount>0?bonusVcFormat.replace('#c',bonusVcAmountText):'')}},factorizeAmountByBaseAmounts:function(amount,baseAmounts,baseAmountKey,resultValueKey,maxIterations){var maxIterations=maxIterations||100;var amountRemainder=parseFloat(amount);var resultValue=0;var counter=0;var baseAmountsPrepared=[];baseAmounts.each(function(value,index){baseAmountsPrepared[index]={};baseAmountsPrepared[index].original_index=index;baseAmountsPrepared[index][baseAmountKey]=parseFloat(baseAmounts[index][baseAmountKey]);baseAmountsPrepared[index][resultValueKey]=parseFloat(baseAmounts[index][resultValueKey])});baseAmountsPrepared.sort(function(a,b){return b[baseAmountKey]-a[baseAmountKey]});var factorizationIndexes=[];var length=baseAmountsPrepared.length;for(var i=0;i<length;i++){while(amountRemainder>=baseAmountsPrepared[i][baseAmountKey]){if(++counter>maxIterations)break;amountRemainder-=baseAmountsPrepared[i][baseAmountKey];resultValue+=baseAmountsPrepared[i][resultValueKey];factorizationIndexes.push(baseAmountsPrepared[i].original_index)}}return{'amount':resultValue,'remainder':amountRemainder,'factorizationIndexes':factorizationIndexes}}});var PaymentSystemMobiamoStandalone=Class.create(PaymentSystems,{open:function(e,system,restoreForm){var ref=this;if(e){Event.stop(e)}this.updateTitle(system);if(system!=this.system||restoreForm){this.updatePricePoints(system)}this.listenRows();this.listenBuyButtonClick();this.handleSelectPricePoint(system);this.switchTab(system||this.system);$$('.default').each(function(item){ref.updateFooter(item.readAttribute('rel'),system)});if(e!==false){if(this.hidePricesBeforeSelection){$(this.contentId).show();if($('pay_methods_container'))$('pay_methods_container').hide();this.showBackButton()}else{this.hideBackButton()}}if(this.iframePaymentMethodOpened){this.iframePaymentMethodOpened=false;this.onClientSideCallbackEvent('paymentProcessingEnd')}this.afterOpen(e)},updateTitle:function(system){var title=this._tx('Select a package');$('header-text').update(title)},updatePricePoints:function(system){var html='';html=this.wrapPricePoints(this.wrapPricePointsSelect(this.buildPricePoints(system),system),system);html+='<b class="clearb"></b>';this.show(html);if(this.couponsFieldAvailable&&!this.isMobileSystem(system)){this.observeCouponClick()}this.afterUpdatePricePoints(system)},wrapPricePointsSelect:function(html,system){var wrapper='<section class="pricepoints">';wrapper+='<div class="pricepoints-wrap">';wrapper+=html;wrapper+='</div>';wrapper+=this.buildButton(system);wrapper+='</section>';return wrapper},buildButton:function(system){var html='<div class="page-wrap"><div id="card_but" class="user-phone-form">';html+='<input type="button" id="ps_psb" value="'+this._tx("Buy")+'" class="user-phone-form-submit">';html+='</div>';return html},buildPricePoints:function(system){var html='<table cellspacing="0" cellpadding="0" border="0" class="package'+(this.useSubscriptions?' subscription2':'')+'" id="ps_price">';var price,p,currencyName;var trialCounter=0;var firstCellPresent=false;var pricepointIterator=0;for(p in this.prices[system]){p=parseInt(p);if(Math.floor(p)==p){price=this.prices[system][p];if(!price['hide']){html+='<tr id="price_'+(price['prefix']?price['prefix']:'')+price['id']+'_" class="'+(pricepointIterator)+((price['default']==1)?' pricepoint_over':'')+(price['product_id']?' product_'+price['product_id']:'')+'">';html+='<td'+(!firstCellPresent?' class="first"':'')+'><input type="radio" value="'+price['id']+'" name="p"'+' class="pricepoint_row'+((price['default']==1)?' default':'')+'"'+((price['default']==1)?' checked':'')+' id="price_'+(price['prefix']?price['prefix']:'')+price['id']+'" rel="'+pricepointIterator+'" />';currencyName=price['currency_name']?price['currency_name']:this.currency;if(price['trial']){trialCounter++;currencyName+=this.buildTrialCounter(trialCounter)}html+='<label rel="'+price['virtual_currency']+' '+this._tx('#c for #amount_formatted').replace('#amount_formatted',price['price']).replace('#c',currencyName)+'" for="price_'+(price['prefix']?price['prefix']:'')+price['id']+'"'+(price['tag']=="best"?'class="best-value"':'')+'>';html+='<div class="pricepoint-label-column '+((price['tag']=="best"||price['tag']=="popular")?'pricepoint-label-colum-left':'')+'">';html+='<div class="vc_name_container"><span class="vc_name_virtual_currency">'+price['virtual_currency']+'</span>';html+=this._tx('#c for #amount_formatted').replace('#amount_formatted','<span class="price-amount">'+price['price']+'</span>').replace('#c','<span class="vc_name">'+currencyName+'</span>');html+='</div>';if(price['discounted_price']){html+='<div class="price-off">'+price['discounted_price']+'</div>'}if(price['comment']){html+='<span>'+price['comment']+'&nbsp;</span>'}if(price['promo']){html+='<span>'+price['promo']+'&nbsp;</span>'}html+='</div>';html+='<div class="pricepoint-label-column">';if(price['tag']==='best'){html+='<span class="best-value-block">'+this._tx("best value")+'</span>'}else if(price['tag']==='popular'){html+='<span class="most-popular-block">'+this._tx("most popular")+'</span>'}else{html+='&nbsp;'}html+='</div>';html+='</label>';html+='</td>';html+='</tr>'}}pricepointIterator++}html+='</table>';return html},handleSelectPricePoint:function(system){ref=this;$$('.pricepoint_row').each(function(element){element.observe('click',function(){ref.updateFooter(element.readAttribute('rel'),system)})})},updateFooter:function(priceIndex,system){var currentPrice=this.prices[system][priceIndex];var priceInfo=currentPrice['info']?currentPrice['info']:'';var operatorHtml='';if(currentPrice['carriers']){var logoHtml=this.customOperatorLogo(currentPrice);if(logoHtml.length){operatorHtml=logoHtml}else{operatorHtml=this.buildOperatorLogoHtml(currentPrice['carriers'])}if(this.opt.showCarrierLogos){$('operators-info').update(operatorHtml).show()}else{$('operators-info').update('<strong>'+this._tx('Available on')+': </strong>'+operatorHtml).show()}}else{$('operators-info').hide()}$('price-info').update(priceInfo);this.updateScrollForPriceInfo()},customOperatorLogo:function(price){var customLogo={NO:{Telenor:"strex.jpg"},DK:{Telenor:"4t.jpg"},SE:{Telenor:"wywallet.png"}};var countryCode=this.countryCode.toUpperCase();if(typeof price['partner']=="undefined"||typeof customLogo[countryCode]=="undefined"||typeof customLogo[countryCode][price['partner']['name']]=="undefined"){return''}return"<img src='"+BaseUrl+"images/widgets/mobiamo/operators/"+customLogo[countryCode][price['partner']['name']]+"'>"},buildOperatorLogoHtml:function(carriers){var operatorHtml='';var carrierName='';var formatedCarrierName='';for(var key in carriers){carrierName=carriers[key]['name'];formatedCarrierName=this.replaceSpecialCharacters(carrierName);operatorHtml+="<img src='"+BaseUrl+"images/widgets/mobiamo/operators/"+formatedCarrierName+".png' alt='"+carrierName+"'>"}return operatorHtml},buildOperatorNameHtml:function(carriers){var carrierInfo=new Array();for(var key in carriers){carrierInfo.push((carriers[key]['name']))}return carrierInfo.join(', ')},replaceSpecialCharacters:function(name){return name.replace(/['\/!:*?"<>| ']/gi,'_').toLowerCase()},updateScrollForPriceInfo:function(){var layout=$('price-info').getLayout();var blockHeight=layout.get('border-box-height');if(blockHeight<50){$('bigText').addClassName('hideScroll')}else{$('bigText').removeClassName('hideScroll')}},selectPrice:function(e){if(e){if(this.appendPaymentForm&&!$(this.priceFormId)){e.target.stopObserving()}Event.stop(e)}if(!this.validateForm()){return}this.initRecentPaymentCheck();if(this.getPrice()=='custom_flexible'){if(($('custom_flexible_amount').value<this.customVC.minAmount||$('custom_flexible_amount').value>this.customVC.maxAmount)){this.showFlexiblePricePopup();return}else{this.hideFlexiblePricePopup()}}this.callOnSelectPriceListeners();var price=this.getPrice();if(price!=''){if($('price_'+price[0])){$('header-text').update($('price_'+price[0]).next('label').readAttribute('rel'))}else if($('price_ag_'+price[0])){$('header-text').update($('price_ag_'+price[0]).next('label').readAttribute('rel'))}if(this.customCommission&&this.confirmFormDefined()){confirmForm.open(this);return false}this.currentPaymentStep='payment';if($(this.priceFormId)){this.showPsWidgetInNewWindow()}else{if(this.loginRequired&&this.loginFormDefined()){loginForm.openSignupFormQuick(this.getPrice());return}this.showPsWidgetInIframe()}}},showSkipPricePointLoader:function(){var loader="<div class='skipPricePointLoader'></div>";$('ps_content').update(loader)},listenRows:function(){var ref=this;$(this.priceId).select(ref.getRowSelectorForListenRows()).each(function(r){if(!ref.togglePriceOverDisable){r.observe('mouseover',ref.togglePriceOver.curry(ref));r.observe('mouseout',ref.togglePriceOver.curry(ref))}r.observe('click',ref.checkPrice.curry(ref))});var checkedPrice=this.getCheckedPrice();if(checkedPrice!=null){var checkedId=checkedPrice.pluck('id')[0]}if(checkedId!='undefined'){this.checkedRow=$(checkedId+'_')}else{var id='price_'+(this.priceDefault['prefix']?this.priceDefault['prefix']:'')+this.priceDefault['id'];this.checkedRow=$(id+'_')}}});var PaymentSystemsFactory=Class.create({factory:function(container,opt){var pricesView=opt.pricesView||0;switch(pricesView){case'select':return new PaymentSystemsSelect(container,opt);case'selectSlim':return new PaymentSystemsSelectSlim(container,opt);case'selectSlimCombo':return new PaymentSystemsSelectSlimCombo(container,opt);case'2click':return new PaymentSystems2Click(container,opt);case'2clickFlexible':return new PaymentSystems2ClickFlexible(container,opt);case'mobilePayPlus':return new PaymentSystemsMobilePayPlus(container,opt);case'mobile':return new PaymentSystemsMobile(container,opt);case'cartClassic':return new PaymentSystemsCart(container,opt);case'mobileOfferwall':return new PaymentSystemsMobileOfferwall(container,opt);case'p10':return new PaymentSystemsP10(container,opt);case'horizontalPricepoints':return new PaymentSystemsHorizontalPricepoints(container,opt);case'goodsDrm':return new PaymentSystemsWithDrm(container,opt);case'mo1':return new PaymentSystemMobiamoStandalone(container,opt);default:return new PaymentSystems(container,opt)}}});function handleRefreshWidget(formPrice){var child=window.open('','_blank');var formPS=(undefined!=formPrice)?formPrice.innerHTML:$('ps_price_table_cnt').innerHTML;child.document.body.innerHTML=formPS.replace('target="_blank"','style="display: none"');child.document.forms[0].submit();var timer=setInterval(function(){if(child.closed){clearInterval(timer);window.location.reload()}},500)};